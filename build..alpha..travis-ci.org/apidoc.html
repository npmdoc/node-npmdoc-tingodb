<div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a

        href="http://www.tingodb.com"

    >tingodb (v0.5.1)</a>
</h1>
<h4>Embedded Node.js database upward compatible with MongoDB</h4>
<div class="apidocSectionDiv"><a
    href="#apidoc.tableOfContents"
    id="apidoc.tableOfContents"
><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb">module tingodb</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tingodb">
            function <span class="apidocSignatureSpan"></span>tingodb
            <span class="apidocSignatureSpan">(opts)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.ObjectId">
            function <span class="apidocSignatureSpan">tingodb.</span>ObjectId
            <span class="apidocSignatureSpan">(val)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.db">
            function <span class="apidocSignatureSpan">tingodb.</span>db
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcache">
            function <span class="apidocSignatureSpan">tingodb.</span>tcache
            <span class="apidocSignatureSpan">(tdb, size)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll">
            function <span class="apidocSignatureSpan">tingodb.</span>tcoll
            <span class="apidocSignatureSpan">(tdb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor">
            function <span class="apidocSignatureSpan">tingodb.</span>tcursor
            <span class="apidocSignatureSpan">(tcoll, query, fields, opts)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb">
            function <span class="apidocSignatureSpan">tingodb.</span>tdb
            <span class="apidocSignatureSpan">(path_, opts, gopts)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex">
            function <span class="apidocSignatureSpan">tingodb.</span>tindex
            <span class="apidocSignatureSpan">(key, tcoll, options, name)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.toString">
            function <span class="apidocSignatureSpan">tingodb.</span>toString
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tstream">
            function <span class="apidocSignatureSpan">tingodb.</span>tstream
            <span class="apidocSignatureSpan">(cursor, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.wqueue">
            function <span class="apidocSignatureSpan">tingodb.</span>wqueue
            <span class="apidocSignatureSpan">(limit, first)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">tingodb.</span>ObjectId.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">tingodb.</span>db.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">tingodb.</span>tbinary</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">tingodb.</span>tcache.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">tingodb.</span>tcode</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">tingodb.</span>tcoll.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">tingodb.</span>tcursor.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">tingodb.</span>tdb.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">tingodb.</span>tindex.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">tingodb.</span>tstream.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">tingodb.</span>utils</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">tingodb.</span>wqueue.prototype</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.ObjectId">module tingodb.ObjectId</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.ObjectId.ObjectId">
            function <span class="apidocSignatureSpan">tingodb.</span>ObjectId
            <span class="apidocSignatureSpan">(val)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.ObjectId.createFromHexString">
            function <span class="apidocSignatureSpan">tingodb.ObjectId.</span>createFromHexString
            <span class="apidocSignatureSpan">(str)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.ObjectId.createFromString">
            function <span class="apidocSignatureSpan">tingodb.ObjectId.</span>createFromString
            <span class="apidocSignatureSpan">(str)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.ObjectId.prototype">module tingodb.ObjectId.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.ObjectId.prototype._init">
            function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>_init
            <span class="apidocSignatureSpan">(val)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.ObjectId.prototype._persist">
            function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>_persist
            <span class="apidocSignatureSpan">(v)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.ObjectId.prototype.equals">
            function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>equals
            <span class="apidocSignatureSpan">(val)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.ObjectId.prototype.inspect">
            function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>inspect
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.ObjectId.prototype.toHexString">
            function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>toHexString
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.ObjectId.prototype.toJSON">
            function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>toJSON
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.ObjectId.prototype.toString">
            function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>toString
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.ObjectId.prototype.valueOf">
            function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>valueOf
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.db">module tingodb.db</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.db.db">
            function <span class="apidocSignatureSpan">tingodb.</span>db
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.db.prototype">module tingodb.db.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.db.prototype.init">
            function <span class="apidocSignatureSpan">tingodb.db.prototype.</span>init
            <span class="apidocSignatureSpan">(path, options, cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.tbinary">module tingodb.tbinary</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tbinary.Binary">
            function <span class="apidocSignatureSpan">tingodb.tbinary.</span>Binary
            <span class="apidocSignatureSpan">(buffer, subType)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.tcache">module tingodb.tcache</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcache.tcache">
            function <span class="apidocSignatureSpan">tingodb.</span>tcache
            <span class="apidocSignatureSpan">(tdb, size)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.tcache.prototype">module tingodb.tcache.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcache.prototype.clear">
            function <span class="apidocSignatureSpan">tingodb.tcache.prototype.</span>clear
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcache.prototype.get">
            function <span class="apidocSignatureSpan">tingodb.tcache.prototype.</span>get
            <span class="apidocSignatureSpan">(k, unsafe)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcache.prototype.set">
            function <span class="apidocSignatureSpan">tingodb.tcache.prototype.</span>set
            <span class="apidocSignatureSpan">(k, v)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcache.prototype.unset">
            function <span class="apidocSignatureSpan">tingodb.tcache.prototype.</span>unset
            <span class="apidocSignatureSpan">(k)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.tcode">module tingodb.tcode</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcode.Code">
            function <span class="apidocSignatureSpan">tingodb.tcode.</span>Code
            <span class="apidocSignatureSpan">(code, scope)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.tcoll">module tingodb.tcoll</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.tcoll">
            function <span class="apidocSignatureSpan">tingodb.</span>tcoll
            <span class="apidocSignatureSpan">(tdb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.tcoll.prototype">module tingodb.tcoll.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.__find">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>__find
            <span class="apidocSignatureSpan">(query, fields, skip, limit, sort, hint, arFields, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype._bestSortIndex">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_bestSortIndex
            <span class="apidocSignatureSpan">(sort)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype._compact">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_compact
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype._ensureIds">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_ensureIds
            <span class="apidocSignatureSpan">(obj)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype._find">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_find
            <span class="apidocSignatureSpan">(query, fields, skip, limit, sort_, hint, arFields, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype._getFS">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_getFS
            <span class="apidocSignatureSpan">(pos, unsafe, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype._getM">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_getM
            <span class="apidocSignatureSpan">(pos, unsafe, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype._putFS">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_putFS
            <span class="apidocSignatureSpan">(item, remove, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype._putM">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_putM
            <span class="apidocSignatureSpan">(item_, remove, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype._refreshIndexes">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_refreshIndexes
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype._stop">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_stop
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype._unwrapTypes">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_unwrapTypes
            <span class="apidocSignatureSpan">(obj)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype._wrapTypes">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_wrapTypes
            <span class="apidocSignatureSpan">(obj)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.compactCollection">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>compactCollection
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.count">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>count
            <span class="apidocSignatureSpan">(query, options, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.createIndex">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>createIndex
            <span class="apidocSignatureSpan">(obj, options, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.drop">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>drop
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.ensureIndex">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>ensureIndex
            <span class="apidocSignatureSpan">(obj, options, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.find">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>find
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.findAndModify">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>findAndModify
            <span class="apidocSignatureSpan">(query, sort, doc, opts, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.findAndRemove">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>findAndRemove
            <span class="apidocSignatureSpan">(query, sort, opts, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.findOne">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>findOne
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.group">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>group
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.indexExists">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>indexExists
            <span class="apidocSignatureSpan">(idx, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.indexes">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>indexes
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.initFS">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>initFS
            <span class="apidocSignatureSpan">(tdb, name, options, create, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.initM">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>initM
            <span class="apidocSignatureSpan">(tdb, name, options, create, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.insert">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>insert
            <span class="apidocSignatureSpan">(docs, opts, cb )</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.mapReduce">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>mapReduce
            <span class="apidocSignatureSpan">(map, reduce, opts, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.remove">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>remove
            <span class="apidocSignatureSpan">(query, opts, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.rename">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>rename
            <span class="apidocSignatureSpan">(nname, opts, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.save">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>save
            <span class="apidocSignatureSpan">(doc, opts, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.stats">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>stats
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcoll.prototype.update">
            function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>update
            <span class="apidocSignatureSpan">(query, doc, opts, cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.tcursor">module tingodb.tcursor</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.tcursor">
            function <span class="apidocSignatureSpan">tingodb.</span>tcursor
            <span class="apidocSignatureSpan">(tcoll, query, fields, opts)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.tcursor.prototype">module tingodb.tcursor.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype._ensure">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>_ensure
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype._get">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>_get
            <span class="apidocSignatureSpan">(pos, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype._projectFields">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>_projectFields
            <span class="apidocSignatureSpan">(obj)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype.batchSize">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>batchSize
            <span class="apidocSignatureSpan">(v, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype.close">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>close
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype.count">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>count
            <span class="apidocSignatureSpan">(applySkipLimit, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype.each">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>each
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype.isClosed">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>isClosed
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype.limit">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>limit
            <span class="apidocSignatureSpan">(v, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype.nextObject">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>nextObject
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype.rewind">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>rewind
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype.setReadPreference">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>setReadPreference
            <span class="apidocSignatureSpan">(the, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype.skip">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>skip
            <span class="apidocSignatureSpan">(v, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype.sort">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>sort
            <span class="apidocSignatureSpan">(v, d, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype.stream">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>stream
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tcursor.prototype.toArray">
            function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>toArray
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.tdb">module tingodb.tdb</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.tdb">
            function <span class="apidocSignatureSpan">tingodb.</span>tdb
            <span class="apidocSignatureSpan">(path_, opts, gopts)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.tdb.prototype">module tingodb.tdb.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.prototype._cloneDeep">
            function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>_cloneDeep
            <span class="apidocSignatureSpan">(obj)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.prototype._collection">
            function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>_collection
            <span class="apidocSignatureSpan">(cname, opts, create, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.prototype._nameCheck">
            function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>_nameCheck
            <span class="apidocSignatureSpan">(cname)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.prototype.close">
            function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>close
            <span class="apidocSignatureSpan">(forceClose, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.prototype.collection">
            function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>collection
            <span class="apidocSignatureSpan">(cname, opts, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.prototype.collectionNames">
            function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>collectionNames
            <span class="apidocSignatureSpan">(opts, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.prototype.collections">
            function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>collections
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.prototype.compactDatabase">
            function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>compactDatabase
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.prototype.createCollection">
            function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>createCollection
            <span class="apidocSignatureSpan">(cname, opts, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.prototype.createIndex">
            function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>createIndex
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.prototype.dropCollection">
            function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>dropCollection
            <span class="apidocSignatureSpan">(cname, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.prototype.dropDatabase">
            function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>dropDatabase
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.prototype.open">
            function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>open
            <span class="apidocSignatureSpan">(options, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tdb.prototype.renameCollection">
            function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>renameCollection
            <span class="apidocSignatureSpan">(on, nn, opts, cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.tindex">module tingodb.tindex</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.tindex">
            function <span class="apidocSignatureSpan">tingodb.</span>tindex
            <span class="apidocSignatureSpan">(key, tcoll, options, name)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.tindex.prototype">module tingodb.tindex.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.prototype._del">
            function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>_del
            <span class="apidocSignatureSpan">(k, v, o)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.prototype._set">
            function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>_set
            <span class="apidocSignatureSpan">(k, v, o)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.prototype.all">
            function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>all
            <span class="apidocSignatureSpan">(order, shallow)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.prototype.clear">
            function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>clear
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.prototype.count">
            function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>count
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.prototype.del">
            function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>del
            <span class="apidocSignatureSpan">(k_, v)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.prototype.depth">
            function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>depth
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.prototype.fields">
            function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>fields
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.prototype.inspect">
            function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>inspect
            <span class="apidocSignatureSpan">(depth)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.prototype.match">
            function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>match
            <span class="apidocSignatureSpan">(k)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.prototype.nuls">
            function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>nuls
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.prototype.range">
            function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>range
            <span class="apidocSignatureSpan">(s, e, si, ei)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.prototype.set">
            function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>set
            <span class="apidocSignatureSpan">(k_, v, check)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tindex.prototype.values">
            function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>values
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.tstream">module tingodb.tstream</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tstream.tstream">
            function <span class="apidocSignatureSpan">tingodb.</span>tstream
            <span class="apidocSignatureSpan">(cursor, options)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.tstream.prototype">module tingodb.tstream.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tstream.prototype._init">
            function <span class="apidocSignatureSpan">tingodb.tstream.prototype.</span>_init
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tstream.prototype._next">
            function <span class="apidocSignatureSpan">tingodb.tstream.prototype.</span>_next
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tstream.prototype._onNextObject">
            function <span class="apidocSignatureSpan">tingodb.tstream.prototype.</span>_onNextObject
            <span class="apidocSignatureSpan">(err, doc)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tstream.prototype.destroy">
            function <span class="apidocSignatureSpan">tingodb.tstream.prototype.</span>destroy
            <span class="apidocSignatureSpan">(err)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tstream.prototype.pause">
            function <span class="apidocSignatureSpan">tingodb.tstream.prototype.</span>pause
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.tstream.prototype.resume">
            function <span class="apidocSignatureSpan">tingodb.tstream.prototype.</span>resume
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.utils">module tingodb.utils</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.utils.intersectIndexes">
            function <span class="apidocSignatureSpan">tingodb.utils.</span>intersectIndexes
            <span class="apidocSignatureSpan">(indexes, base)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.wqueue">module tingodb.wqueue</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.wqueue.wqueue">
            function <span class="apidocSignatureSpan">tingodb.</span>wqueue
            <span class="apidocSignatureSpan">(limit, first)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.tingodb.wqueue.prototype">module tingodb.wqueue.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.wqueue.prototype._exec">
            function <span class="apidocSignatureSpan">tingodb.wqueue.prototype.</span>_exec
            <span class="apidocSignatureSpan">(task, block, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.wqueue.prototype._ping">
            function <span class="apidocSignatureSpan">tingodb.wqueue.prototype.</span>_ping
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.tingodb.wqueue.prototype.add">
            function <span class="apidocSignatureSpan">tingodb.wqueue.prototype.</span>add
            <span class="apidocSignatureSpan">(task, block, cb)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb" id="apidoc.module.tingodb">module tingodb</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tingodb" id="apidoc.element.tingodb.tingodb">
        function <span class="apidocSignatureSpan"></span>tingodb
        <span class="apidocSignatureSpan">(opts)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">tingodb = function (opts) {
	opts = opts || {};
	var db = require(&#x27;./tdb.js&#x27;);
	var ObjectID = opts.nativeObjectID ? (require(&#x22;bson&#x22;).ObjectID || require(&#x22;mongodb&#x22;).ObjectID) : require(&#x22;./ObjectId&#x22;);
	if (opts.nativeObjectID) {
		ObjectID.prototype.valueOf = function () {
			return this.toString();
		}
	}
	function gdb (path,optsLocal) {
		gdb.superclass.constructor.call(this, path, optsLocal, opts);
		this.ObjectID = ObjectID;
		this.Code = require(&#x27;./tcode.js&#x27;).Code;
		this.Binary = require(&#x27;./tbinary.js&#x27;).Binary;
		this.Finder = require(&#x22;./finder&#x22;)(this);
	}
	var F = function() { }
    F.prototype = db.prototype
    gdb.prototype = new F()
    gdb.prototype.constructor = gdb
    gdb.superclass = db.prototype
	return {
		Db:gdb,
		Collection:require(&#x27;./tcoll.js&#x27;),
		Code:require(&#x27;./tcode.js&#x27;).Code,
		Binary:require(&#x27;./tbinary.js&#x27;).Binary,
		ObjectID:ObjectID
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.ObjectId" id="apidoc.element.tingodb.ObjectId">
        function <span class="apidocSignatureSpan">tingodb.</span>ObjectId
        <span class="apidocSignatureSpan">(val)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ObjectID(val) {
	// every new instance will have temporary inproc unique value
	// minus sign will let know to db layer that value is temporary
	// and need to be replaced
	this.id = --inproc_id;
	this._init(val);
	// we need to keep track all temporary instances with goal
	// to update them at later tima
	if (this.id&#x3c;0) {
		if (!tempset[this.id])
			tempset[this.id]=[this];
		else
			tempset[this.id].push(this);
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.db" id="apidoc.element.tingodb.db">
        function <span class="apidocSignatureSpan">tingodb.</span>db
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function tdb() {}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcache" id="apidoc.element.tingodb.tcache">
        function <span class="apidocSignatureSpan">tingodb.</span>tcache
        <span class="apidocSignatureSpan">(tdb, size)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function tcache(tdb, size) {
	this._tdb = tdb;
	this.size = size || 1000;
	this._cache = [];
	this._cache.length = this.size;
	this.clear();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll" id="apidoc.element.tingodb.tcoll">
        function <span class="apidocSignatureSpan">tingodb.</span>tcoll
        <span class="apidocSignatureSpan">(tdb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function tcoll(tdb) {
	this._tdb = null;
	this._name = null;
	this._store = Object.create ? Object.create(null) : {};
	this._fd = null;
	this._fsize = null;
	this._id = 1;
	this._wq = new wqueue();
	this._tq = null;
	this._idx = Object.create ? Object.create(null) : {};
	this._cache = null;
	// this._mc = {};
	this._check1 = Math.random()*100+1;
	// native mongo db compatibility attrs
	this.collectionName = null;
	if (tdb._stype==&#x22;mem&#x22;) {
		this.init = this.initM;
		this._put = this._putM;
		this._get = this._getM;
	} else {
		this.init = this.initFS;
		this._put = this._putFS;
		this._get = this._getFS;
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor" id="apidoc.element.tingodb.tcursor">
        function <span class="apidocSignatureSpan">tingodb.</span>tcursor
        <span class="apidocSignatureSpan">(tcoll, query, fields, opts)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function tcursor(tcoll, query, fields, opts) {
	var self = this;
	this.INIT = 0;
	this.OPEN = 1;
	this.CLOSED = 2;
	this.GET_MORE = 3;
	this._query = query;
	this._c = tcoll;
	this._i = 0;
	this._skip = 0;
	this._limit = null;
	this._count = null;
	this._items = null;
	this._sort = null;
	this._hint = opts.hint;
	this._arFields = Object.create ? Object.create(null) : {};
	this._fieldsType = null;
	this._fieldsExcludeId = false;
	this._fields = Object.create ? Object.create(null) : {};
	this.timeout = _.isUndefined(opts.timeout)?true:opts.timeout;

	_.each(fields, function (v,k) {
		if (!k &#x26;&#x26; _.isString(v)) {
			k=v; v = 1;
		}
		if (v == 0 || v==1) {
			// _id treated specially
			if (k==&#x22;_id&#x22; &#x26;&#x26; v==0) {
				self._fieldsExcludeId = true;
				return;
			}

			if (self._fieldsType==null)
				self._fieldsType = v;
			if (self._fieldsType==v) {
				if (k.indexOf(&#x22;_tiar.&#x22;)==0)
					self._arFields[k.substr(6)]=1;
				else
					self._fields[k]=v;
			} else if (!self._err)
				self._err = new Error(&#x22;Mixed set of projection options (0,1) is not valid&#x22;);
		} else if (!self._err)
			self._err = new Error(&#x22;Unsupported projection option: &#x22;+JSON.stringify(v));
	})
	// _id treated specially
	if ((self._fieldsType===0 || self._fieldsType===null) &#x26;&#x26; self._fieldsExcludeId) {
		self._fieldsType = 0;
		self._fields[&#x27;_id&#x27;]=0;
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tdb" id="apidoc.element.tingodb.tdb">
        function <span class="apidocSignatureSpan">tingodb.</span>tdb
        <span class="apidocSignatureSpan">(path_, opts, gopts)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function tdb(path_, opts, gopts) {
	this._gopts = gopts;
	this._path = path.resolve(path_);
	this._cols = Object.create ? Object.create(null) : {};
	this._name = opts.name || path.basename(path_);
	this._stype = gopts.memStore?&#x22;mem&#x22;:&#x22;fs&#x22;;
	if (this._stype==&#x22;mem&#x22;)
		mstore[path_] = this._mstore = mstore[path_] || Object.create ? Object.create(null) : {};
	// mongodb compat variables
	this.openCalled = false;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tindex" id="apidoc.element.tingodb.tindex">
        function <span class="apidocSignatureSpan">tingodb.</span>tindex
        <span class="apidocSignatureSpan">(key, tcoll, options, name)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function tindex(key, tcoll, options, name) {
	this.options = options || {};
	this.name = name || key+&#x27;_&#x27;;
	this._unique = this.options.unique || false;
	this._c = tcoll;
	this._nuls = Object.create ? Object.create(null) : {};
	this._array = this.options._tiarr || false;
	this.key = key[0][0];
	this.order = key[0][1];
	if (key.length &#x3e; 1) this._sub = key.slice(1);
	this._bp = BPlusTree.create({ sort: this.order, order: 100 });
	var getter = new tcoll._tdb.Finder.field(this.key);
	this._get = new Function(&#x22;obj&#x22;, &#x22;return &#x22; + (this._array ? getter.native3() : getter.native()));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.toString" id="apidoc.element.tingodb.toString">
        function <span class="apidocSignatureSpan">tingodb.</span>toString
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toString = function () {
    return text;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
					// it&#x27;s ok also to not provide id, then it will be generated
					rooms.insert({name:&#x22;room_&#x22;+i,_idHome:homeId}, function (err, room) {
						console.log(room[0]);
						i--;
						if (i==0) {
							// now lets assume we serving request like
							// /rooms?homeid=_some_string_
							var query = &#x22;/rooms?homeid=&#x22;+homeId.<span class="apidocCodeKeywordSpan">toString</span>();
							// dirty code to get simulated GET variable
							var getId = query.match(&#x22;homeid=(.*)&#x22;)[1];
							console.log(query, getId)
							// typical code to get id from external world
							// and use it for queries
							rooms.find({_idHome:new engine.ObjectID(getId)})
								.count(function (err, count) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tstream" id="apidoc.element.tingodb.tstream">
        function <span class="apidocSignatureSpan">tingodb.</span>tstream
        <span class="apidocSignatureSpan">(cursor, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function CursorStream(cursor, options) {
  if(!(this instanceof CursorStream)) return new CursorStream(cursor);
  options = options ? options : {};

  Stream.call(this);

  this.readable = true;
  this.paused = false;
  this._cursor = cursor;
  this._destroyed = null;
  this.options = options;

  // give time to hook up events
  var self = this;
  process.nextTick(function() {
    self._init();
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.wqueue" id="apidoc.element.tingodb.wqueue">
        function <span class="apidocSignatureSpan">tingodb.</span>wqueue
        <span class="apidocSignatureSpan">(limit, first)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function wqueue(limit, first) {
	this.limit = limit || 100;
	this._rc = 0;
	this._q = [];
	this._blocked = false;
	this._stoped = false;
	this._tc = -1;
	this.first = first || function (cb) {cb()};
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


























</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.ObjectId" id="apidoc.module.tingodb.ObjectId">module tingodb.ObjectId</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.ObjectId.ObjectId" id="apidoc.element.tingodb.ObjectId.ObjectId">
        function <span class="apidocSignatureSpan">tingodb.</span>ObjectId
        <span class="apidocSignatureSpan">(val)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function ObjectID(val) {
	// every new instance will have temporary inproc unique value
	// minus sign will let know to db layer that value is temporary
	// and need to be replaced
	this.id = --inproc_id;
	this._init(val);
	// we need to keep track all temporary instances with goal
	// to update them at later tima
	if (this.id&#x3c;0) {
		if (!tempset[this.id])
			tempset[this.id]=[this];
		else
			tempset[this.id].push(this);
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.ObjectId.createFromHexString" id="apidoc.element.tingodb.ObjectId.createFromHexString">
        function <span class="apidocSignatureSpan">tingodb.ObjectId.</span>createFromHexString
        <span class="apidocSignatureSpan">(str)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">createFromHexString = function (str) {
	return new ObjectID(str);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.ObjectId.createFromString" id="apidoc.element.tingodb.ObjectId.createFromString">
        function <span class="apidocSignatureSpan">tingodb.ObjectId.</span>createFromString
        <span class="apidocSignatureSpan">(str)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">createFromString = function (str) {
	return new ObjectID(str);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.ObjectId.prototype" id="apidoc.module.tingodb.ObjectId.prototype">module tingodb.ObjectId.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.ObjectId.prototype._init" id="apidoc.element.tingodb.ObjectId.prototype._init">
        function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>_init
        <span class="apidocSignatureSpan">(val)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_init = function (val) {
	if (_.isNumber(val))
		this.id = val;
	else if (val instanceof ObjectID)
		this.id = val.id;
	else if (_.isString(val)) {
		if (/^-?\d+$/.test(val))
			this.id = parseInt(val)
		else
			this.id = NaN;
	}
	if (val &#x26;&#x26; isNaN(this.id))
		throw new Error(&#x22;ObjectId should be ObjectId (whatever it is designed to be) &#x22;+val)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var inproc_id = -1;
var tempset = {};
function ObjectID(val) {
	// every new instance will have temporary inproc unique value
	// minus sign will let know to db layer that value is temporary
	// and need to be replaced
	this.id = --inproc_id;
	this.<span class="apidocCodeKeywordSpan">_init</span>(val);
	// we need to keep track all temporary instances with goal
	// to update them at later tima
	if (this.id&#x3c;0) {
		if (!tempset[this.id])
			tempset[this.id]=[this];
		else
			tempset[this.id].push(this);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.ObjectId.prototype._persist" id="apidoc.element.tingodb.ObjectId.prototype._persist">
        function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>_persist
        <span class="apidocSignatureSpan">(v)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_persist = function (v) {
	var oldid = this.id;
	if (oldid&#x3c;0) {
		_.each(tempset[oldid], function (oid) {
			oid.id = v;
		});
		delete tempset[oldid];
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
				throw new Error(&#x22;key &#x22;+k+&#x22; must not start with &#x27;$&#x27;&#x22;);
			if (k.indexOf(&#x27;.&#x27;)!=-1)
				throw new Error(&#x22;key &#x22;+k+&#x22; must not contain &#x27;.&#x27;&#x22;);
		}
		if (_.isObject(v)) {
			if (v instanceof self._tdb.ObjectID) {
				if (v.id&#x3c;0) {
					v.<span class="apidocCodeKeywordSpan">_persist</span>(++self._id)
				}
			}
			else
				self._ensureIds(v)
		}
	})
	return obj;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.ObjectId.prototype.equals" id="apidoc.element.tingodb.ObjectId.prototype.equals">
        function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>equals
        <span class="apidocSignatureSpan">(val)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">equals = function (val) {
	if (val instanceof ObjectID)
		return this.id==val.id;
	else {
		var temp = new ObjectID(val);
		return this.id==temp.id;
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.ObjectId.prototype.inspect" id="apidoc.element.tingodb.ObjectId.prototype.inspect">
        function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>inspect
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">inspect = function () {
	return this.id.toString();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.ObjectId.prototype.toHexString" id="apidoc.element.tingodb.ObjectId.prototype.toHexString">
        function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>toHexString
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toHexString = function () {
	var l = this.id.toString();
	var zeros = &#x22;000000000000000000000000&#x22;;
	return zeros.substr(0,zeros.length - l.length)+l;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.ObjectId.prototype.toJSON" id="apidoc.element.tingodb.ObjectId.prototype.toJSON">
        function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>toJSON
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toJSON = function () {
	return this.id;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

tcoll.prototype._wrapTypes = function(obj) {
	var self = this;
	_.each(obj, function (v,k) {
		if (_.isDate(v))
			obj[k] = {$wrap:&#x22;$date&#x22;,v:v.valueOf(),h:v}
		else if (v instanceof self._tdb.ObjectID)
			obj[k] = {$wrap:&#x22;$oid&#x22;,v:v.<span class="apidocCodeKeywordSpan">toJSON</span>()}
		else if (v instanceof self._tdb.Binary)
			obj[k] = {$wrap: &#x22;$bin&#x22;, v: v.toJSON()};
		else if (_.isObject(v))
			self._wrapTypes(v)

	})
	return obj;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.ObjectId.prototype.toString" id="apidoc.element.tingodb.ObjectId.prototype.toString">
        function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>toString
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toString = function () {
	return this.id.toString();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
					// it&#x27;s ok also to not provide id, then it will be generated
					rooms.insert({name:&#x22;room_&#x22;+i,_idHome:homeId}, function (err, room) {
						console.log(room[0]);
						i--;
						if (i==0) {
							// now lets assume we serving request like
							// /rooms?homeid=_some_string_
							var query = &#x22;/rooms?homeid=&#x22;+homeId.<span class="apidocCodeKeywordSpan">toString</span>();
							// dirty code to get simulated GET variable
							var getId = query.match(&#x22;homeid=(.*)&#x22;)[1];
							console.log(query, getId)
							// typical code to get id from external world
							// and use it for queries
							rooms.find({_idHome:new engine.ObjectID(getId)})
								.count(function (err, count) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.ObjectId.prototype.valueOf" id="apidoc.element.tingodb.ObjectId.prototype.valueOf">
        function <span class="apidocSignatureSpan">tingodb.ObjectId.prototype.</span>valueOf
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">valueOf = function () {
	return this.id;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		var s = &#x22;(&#x22;;
		var ps = &#x22;obj&#x22;;
		for (var i=0;i&#x3c;path.length;i++) {
			ps+=&#x22;[&#x27;&#x22;+path[i]+&#x22;&#x27;]&#x22;;
			if (i!=path.length-1)
				s+=ps+ &#x22; &#x26;&#x26; &#x22;;
			else
				s+= &#x22;(&#x22;+ps+&#x22; &#x26;&#x26; &#x22;+ps+&#x22;.<span class="apidocCodeKeywordSpan">valueOf</span>()&#x22;+&#x22;) )&#
x22;;
		}
		return s;
	}
	this.native3 = function () {
		function steep(ps, path, i) {
			ps+=&#x22;[&#x27;&#x22;+path[i]+&#x22;&#x27;]&#x22;;
			if (path.length==i)
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.db" id="apidoc.module.tingodb.db">module tingodb.db</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.db.db" id="apidoc.element.tingodb.db.db">
        function <span class="apidocSignatureSpan">tingodb.</span>db
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function tdb() {}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.db.prototype" id="apidoc.module.tingodb.db.prototype">module tingodb.db.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.db.prototype.init" id="apidoc.element.tingodb.db.prototype.init">
        function <span class="apidocSignatureSpan">tingodb.db.prototype.</span>init
        <span class="apidocSignatureSpan">(path, options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">init = function (path, options, cb) {
	this._path = path;
	cb(null);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	if (c) {
		if (opts.strict &#x26;&#x26; create) safe.back(cb, new Error(&#x22;Collection &#x22; + cname + &#x22; already exists. Currently
 in safe mode.&#x22;));
		else safe.back(cb, null, c);
		return c;
	}
	c = new tcoll(this);
	self._cols[cname] = c;
	c.<span class="apidocCodeKeywordSpan">init</span>(this, cname, opts, create, function (err) {
		if (err) {
			delete self._cols[cname];
			cb(err);
		} else
			cb(null, c);
	});
	return c;
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.tbinary" id="apidoc.module.tingodb.tbinary">module tingodb.tbinary</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tbinary.Binary" id="apidoc.element.tingodb.tbinary.Binary">
        function <span class="apidocSignatureSpan">tingodb.tbinary.</span>Binary
        <span class="apidocSignatureSpan">(buffer, subType)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Binary(buffer, subType) {
  if(!(this instanceof Binary)) return new Binary(buffer, subType);

  this._bsontype = &#x27;Binary&#x27;;

  if(buffer instanceof Number) {
    this.sub_type = buffer;
    this.position = 0;
  } else {
    this.sub_type = subType == null ? BSON_BINARY_SUBTYPE_DEFAULT : subType;
    this.position = 0;
  }

  if(buffer != null &#x26;&#x26; !(buffer instanceof Number)) {
    // Only accept Buffer, Uint8Array or Arrays
    if(_.isString(buffer)) {
      // Different ways of writing the length of the string for the different types
      if(typeof Buffer !== &#x27;undefined&#x27;) {
        this.buffer = new Buffer(buffer);
      } else if(typeof Uint8Array !== &#x27;undefined&#x27; || _.isArray(buffer)) {
        this.buffer = writeStringToArray(buffer);
      } else {
        throw new Error(&#x22;only String, Buffer, Uint8Array or Array accepted&#x22;);
      }
    } else {
      this.buffer = buffer;
    }
    this.position = buffer.length;
  } else {
    if(typeof Buffer !== &#x27;undefined&#x27;) {
      this.buffer =  new Buffer(Binary.BUFFER_SIZE);
    } else if(typeof Uint8Array !== &#x27;undefined&#x27;){
      this.buffer = new Uint8Array(new ArrayBuffer(Binary.BUFFER_SIZE));
    } else {
      this.buffer = new Array(Binary.BUFFER_SIZE);
    }
    // Set position to start of buffer
    this.position = 0;
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
			switch (v.$wrap) {
				case &#x22;$date&#x22;: obj[k] = new Date(v.v); break;
				case &#x22;$oid&#x22;:
					var oid = new self._tdb.ObjectID(v.v);
					obj[k]=oid;
				break;
				case &#x22;$bin&#x22;:
					var bin = new self._tdb.<span class="apidocCodeKeywordSpan">Binary</span>(new Buffer(v.v, &#x27;base64&#x27;));
					obj[k] = bin;
				break;
				default: self._unwrapTypes(v);
			}
		}
	})
	return obj;
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.tcache" id="apidoc.module.tingodb.tcache">module tingodb.tcache</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tcache.tcache" id="apidoc.element.tingodb.tcache.tcache">
        function <span class="apidocSignatureSpan">tingodb.</span>tcache
        <span class="apidocSignatureSpan">(tdb, size)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function tcache(tdb, size) {
	this._tdb = tdb;
	this.size = size || 1000;
	this._cache = [];
	this._cache.length = this.size;
	this.clear();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.tcache.prototype" id="apidoc.module.tingodb.tcache.prototype">module tingodb.tcache.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tcache.prototype.clear" id="apidoc.element.tingodb.tcache.prototype.clear">
        function <span class="apidocSignatureSpan">tingodb.tcache.prototype.</span>clear
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">clear = function () {
	for (var i=0; i&#x3c;this._cache.length; i++) {
		this._cache[i]={k:null};
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
// var BPlusTree = require(&#x27;./bplustree&#x27;);

function tcache (tdb, size) {
	this._tdb = tdb;
	this.size = size || 1000;
	this._cache = [];
	this._cache.length = this.size;
	this.<span class="apidocCodeKeywordSpan">clear</span>();
}

tcache.prototype.clear = function () {
	for (var i=0; i&#x3c;this._cache.length; i++) {
		this._cache[i]={k:null};
	}
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcache.prototype.get" id="apidoc.element.tingodb.tcache.prototype.get">
        function <span class="apidocSignatureSpan">tingodb.tcache.prototype.</span>get
        <span class="apidocSignatureSpan">(k, unsafe)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get = function (k, unsafe) {
	var c = this._cache[k%this.size];
	return c.k == k ? (unsafe?c.v:this._tdb._cloneDeep(c.v)) : null;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

tcoll.prototype._getM = function (pos, unsafe, cb) {
	safe.back(cb,null,unsafe?this._mstore[pos-1]:this._tdb._cloneDeep(this._mstore[pos-1]));
};

tcoll.prototype._getFS = function (pos, unsafe, cb) {
	var self = this;
	var cached = self._cache.<span class="apidocCodeKeywordSpan">get</span>(pos,unsafe);
	if (cached)
		return safe.back(cb,null,cached);
	var b1 = new Buffer(45);
	fs.read(self._fd, b1, 0, 45, pos, safe.trap_sure(cb, function (bytes, data) {
		var h1 = JSON.parse(data.toString());
		h1.o = parseInt(h1.o,10);
		h1.k = parseInt(h1.k,10);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcache.prototype.set" id="apidoc.element.tingodb.tcache.prototype.set">
        function <span class="apidocSignatureSpan">tingodb.tcache.prototype.</span>set
        <span class="apidocSignatureSpan">(k, v)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">set = function (k, v) {
	this._cache[k%this.size] = {k:k,v:this._tdb._cloneDeep(v)};
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	}
	this._tq = new wqueue(100, function (cb) {
		// update indexes
		safe.eachOfSeries(self._store, function (rec, k, cb) {
			self._get(rec.pos, false, safe.sure(cb, function (obj) {
				var id = simplifyKey(obj._id);
				_.each(self._idx,function(v, k) {
					v.<span class="apidocCodeKeywordSpan">set</span>(obj, id);
				});
				cb();
			}));
		}, cb);
	});
	self.ensureIndex({_id: 1}, {name: &#x27;_id_&#x27;, unique: true}, cb);
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcache.prototype.unset" id="apidoc.element.tingodb.tcache.prototype.unset">
        function <span class="apidocSignatureSpan">tingodb.tcache.prototype.</span>unset
        <span class="apidocSignatureSpan">(k)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">unset = function (k) {
	var c = this._cache[k%this.size];
	if (c.k==k)
		this._cache[k%this.size]={k:null};
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
			fs.write(self._fd, buf, 0, buf.length, self._fsize, safe.sure(cb, function (written) {
				if (remove)
					delete self._store[key._id];
				else
					self._store[key._id] = { pos: self._fsize, sum: key._s };

				if (remove || sobj.length &#x3e; self._cmaxobj)
					self._cache.<span class="apidocCodeKeywordSpan">unset</span>(self._fsize)
				else
					self._cache.set(self._fsize,item);
				self._fsize+=written;
				// randomly check for non exclusive file usage
				// which is growth of file that we are nor aware
				// randomly to avoid overhead
				if (self._check1==0) {
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.tcode" id="apidoc.module.tingodb.tcode">module tingodb.tcode</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tcode.Code" id="apidoc.element.tingodb.tcode.Code">
        function <span class="apidocSignatureSpan">tingodb.tcode.</span>Code
        <span class="apidocSignatureSpan">(code, scope)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Code(code, scope) {
  if(!(this instanceof Code)) return new Code(code, scope);

  this._bsontype = &#x27;Code&#x27;;
  this.code = code;
  this.scope = scope == null ? {} : scope;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.tcoll" id="apidoc.module.tingodb.tcoll">module tingodb.tcoll</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tcoll.tcoll" id="apidoc.element.tingodb.tcoll.tcoll">
        function <span class="apidocSignatureSpan">tingodb.</span>tcoll
        <span class="apidocSignatureSpan">(tdb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function tcoll(tdb) {
	this._tdb = null;
	this._name = null;
	this._store = Object.create ? Object.create(null) : {};
	this._fd = null;
	this._fsize = null;
	this._id = 1;
	this._wq = new wqueue();
	this._tq = null;
	this._idx = Object.create ? Object.create(null) : {};
	this._cache = null;
	// this._mc = {};
	this._check1 = Math.random()*100+1;
	// native mongo db compatibility attrs
	this.collectionName = null;
	if (tdb._stype==&#x22;mem&#x22;) {
		this.init = this.initM;
		this._put = this._putM;
		this._get = this._getM;
	} else {
		this.init = this.initFS;
		this._put = this._putFS;
		this._get = this._getFS;
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.tcoll.prototype" id="apidoc.module.tingodb.tcoll.prototype">module tingodb.tcoll.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.__find" id="apidoc.element.tingodb.tcoll.prototype.__find">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>__find
        <span class="apidocSignatureSpan">(query, fields, skip, limit, sort, hint, arFields, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">__find = function (query, fields, skip, limit, sort, hint, arFields, cb) {
	var self = this;
	var range;
	// find sort index
	var si = this._bestSortIndex(sort);
	// for non empty query check indexes that we can use
	var qt = self._tdb.Finder.matcher(query);
	var pi = [];
	if (_.size(qt)&#x3e;0) {
		_.each(self._idx,function (i) {
			var f = _.map(i.fields(), 0);
			var e = _.takeWhile(f, function (k) {
				return qt._ex(k) == 1 &#x26;&#x26; (!hint || hint[k]);
			});
			if (e.length &#x3e; 0) pi.push({ i: i, k: e, e: f.length &#x3e; e.length });
		});
	}

	// if possible indexes found split the query and process
	// indexes separately
	if (!_.isEmpty(pi)) {
		// choose the most appropriate indexes
		reduceIndexSet(pi);
		// split query
		var io = {};
		_.each(pi,function (v) {
			_.each(v.k,function (k) {
				if (!io[k]) io[k] = qt.split(k);
			});
		});
		// process indexes
		var p = _.map(pi,function (st) {
			// this action applies to all indexes
			var r = io[st.k[0]]._index(st.i);
			// process subfields of compound index
			_.each(st.k.slice(1),function (k) {
				var v = io[k];
				r = _(r).map(function (si) { return v._index(si); }).flatten().value();
			});
			// expand subindexes to plain ids
			if (st.e) r = _(r).map(function (si) { return si.all(); }).flatten().value();
			// store result of index search
			return r;
		});
		if (p.length == 1) {
			p = p[0];
			// optimization for the case when search and sorting indexes are the same
			if (si &#x26;&#x26; pi[0].i === si) {
				var sif = si.fields();
				if (_.every(sort, function (v, i) { return sif[i][1] == v[1]; })) {
					// sort order exactly matches index order,
					// so the result is already sorted
					sort = null;
				} else if (_.every(sort, function (v, i) { return sif[i][1] == -v[1]; })) {
					// sort order is exactly opposite to index order,
					// so the result is sorted, but in reverse direction
					p.reverse();
					sort = null;
				}
			}
		} else {
			// TODO: use sort index as intersect base to speedup sorting
			p = tutils.intersectIndexes(p);
		}
		// nowe we have ids, need to convert them to positions
		range = _.map(p,function (_id) {
			return self._store[_id].pos;
		})
	} else {
		if (si) {
			range = _.map(si.all(_.map(sort, 1)), function (_id) {
				return self._store[_id].pos;
			})
			//if (order==-1)
			//	range.reverse();
			sort = null;
		} else
			range = _(self._store).values().map(&#x27;pos&#x27;).value();
	}

	if (sort &#x26;&#x26; si) {
		var ps = {};
		_.each(range, function (pos) {
			ps[pos] = true;
		});
		range = [];
		_.each(si.all(_.map(sort, 1)), function (_id) {
			var pos = self._store[_id].pos;
			if (_.has(ps, pos))
				range.push(pos);
		});
		//if (order == -1)
		//	range.reverse();
		sort = null;
	}

	// no sort, no query then return right away
	if (sort==null &#x26;&#x26; (_.size(qt)==0 || qt._args.length==0)) {
		if (skip!=0 || limit!=null) {
			var c = Math.min(range.length-skip,limit?limit:range.length-skip);
			range = range.splice(skip,c)
		}
		return safe.back(cb,null,range);
	}

	// check if we can use simple match or array match function
	var arrayMatch = false;
	if (self._tdb._gopts.searchInArray)
		arrayMatch = true;
	else {
		_.each(qt.fields(), function (v,k) {
			if (_.get(arFields, k)) {
				arrayMatch = true;
				return false;
			}
		})
	}

	var matcher = new Function(&#x22;obj&#x22;, &#x22;return &#x22; + (arrayMatch ? qt.native3() : qt.native()));

	// create sort index
	if (sort) {
		si = new tindex(sort,self);
	}

	// now simple non-index search
	var res = [];
	var found = 0;
	safe.forEachSeries(range, function (pos, cb) {
		if (sort==null &#x26;&#x26; limit &#x26;&#x26; res.length&#x3e;=limit)
			return safe.back(cb);
		self._get(pos, true, safe.sure(cb, function (obj) {
			if (matcher(obj)) {
				if (sort!=null || found&#x3e;=skip) {
					if (sort==null)
						res.push(pos);
					else
						si.set(obj,pos);
				}
				found++;
			}
			cb()
		}))
	}, safe.sure(cb, function () {
		if (sort) {
			res = si.all();
			//if (order==-1) {
			//	res.reverse();
			//}
			if (skip!=0 || limit!=null) {
				var c = Math.min(res.length-skip,limit?limit:res.length-skip);
				res = res.splice(skip,c)
			}
		}
		cb(null, ...</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	if (!_.isObject(doc))
		throw new Error(&#x22;document must be a valid JavaScript object&#x22;);

	var multi = opts.multi || false;
    var updater = new Updater(doc, self._tdb);
	var $doc = updater.hasAtomic()?null:doc;
	this._tq.add(function (cb) {
		self.<span class="apidocCodeKeywordSpan">__find</span>(query, null, 0, multi ? null : 1, null, opts.hint, {}, safe.sure(cb, function
 (res) {
			if (res.length==0) {
				if (opts.upsert) {
					$doc = $doc || query;
					$doc = self._tdb._cloneDeep($doc);
					updater.update($doc,true);
					if (_.isUndefined($doc._id))
						$doc._id = new self._tdb.ObjectID();
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype._bestSortIndex" id="apidoc.element.tingodb.tcoll.prototype._bestSortIndex">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_bestSortIndex
        <span class="apidocSignatureSpan">(sort)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_bestSortIndex = function (sort) {
	// no sort
	if (!sort) return null;
	// exact match
	if (this._idx[sort]) return this._idx[sort];
	// find potential sort indexes
	var pi = [];
	_.each(this._idx,function (idx) {
		var fields = idx.fields();
		var match = _.takeWhile(fields, function (kv, i) {
			return i &#x3c; sort.length ? kv[0] == sort[i][0] : false;
		});
		if (match.length == sort.length) {
			var score = fields.length;
			_.each(sort,function (kv, i) {
				if (kv[1] != fields[i][1]) score += 1;
			});
			pi.push({ value: idx, score: score });
		}
	});
	if (pi.length === 0) return null;
	// select best index
	pi = pi.sort(function (l, r) { return l.score &#x3c; r.score; });
	return pi[0].value;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	} while (hit);
}

tcoll.prototype.__find = function (query, fields, skip, limit, sort, hint, arFields, cb) {
	var self = this;
	var range;
	// find sort index
	var si = this.<span class="apidocCodeKeywordSpan">_bestSortIndex</span>(sort);
	// for non empty query check indexes that we can use
	var qt = self._tdb.Finder.matcher(query);
	var pi = [];
	if (_.size(qt)&#x3e;0) {
		_.each(self._idx,function (i) {
			var f = _.map(i.fields(), 0);
			var e = _.takeWhile(f, function (k) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype._compact" id="apidoc.element.tingodb.tcoll.prototype._compact">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_compact
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_compact = function (cb) {
	var self = this;
	var filename = self._filename + &#x27;.compact&#x27;;
	fs.open(filename, &#x27;w+&#x27;, safe.sure(cb, function (fd) {
		var b1 = new Buffer(45);
		function get(pos, cb) {
			fs.read(self._fd, b1, 0, 45, pos, safe.trap_sure(cb, function (bytes, data) {
				var h1 = JSON.parse(data.toString());
				h1.o = parseInt(h1.o, 10);
				h1.k = parseInt(h1.k, 10);
				var b2 = new Buffer(h1.k + h1.o + 3);
				fs.read(self._fd, b2, 0, b2.length, pos + 45, safe.sure(cb, function (bytes, data) {
					cb(null, Buffer.concat([ b1, b2 ]));
				}));
			}));
		}
		var wpos = 0;
		var store = Object.create ? Object.create(null) : {};
		safe.eachOfSeries(self._store, function (rec, k, cb) {
			get(rec.pos, safe.sure(cb, function (data) {
				fs.write(fd, data, 0, data.length, wpos, safe.sure(cb, function (written) {
					if (written != data.length) return cb(new Error(&#x27;Insufficient disk space&#x27;));
					store[k] = { pos: wpos, sum: rec.sum };
					wpos += data.length;
					cb();
				}));
			}));
		}, function (err) {
			if (err) {
				fs.close(fd, function () {
					fs.unlink(filename, function () {
						cb(err);
					});
				});
				return;
			}
			if (!!process.platform.match(/^win/)) {
				// WINDOWS: unsafe because if something fail while renaming file it will not
				// restore automatically
				fs.close(self._fd, safe.sure(cb,function() {
					fs.close(fd, safe.sure(cb,function() {
						fs.unlink(self._filename, safe.sure(cb,function () {
							fs.rename(filename, self._filename, safe.sure(cb, function () {
								fs.open(self._filename, &#x27;a+&#x27;, safe.sure(cb, function (fd) {
									self._fd = fd;
									self._fsize = wpos;
									self._store = store;
									cb();
								}));
							}));
						}));
					}));
				}));
		    } else {
				// safe way
				fs.rename(filename, self._filename, safe.sure(cb, function () {
					fs.close(self._fd);
					self._fd = fd;
					self._fsize = wpos;
					self._store = store;
					cb();
				}));
			}
		});
	}));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
			if (!found &#x26;&#x26; err)
				return cb(err); // nothing read and error, just rise it

			safe.run(function (cb) {
				var size = _.size(self._store);
				// autocompact on certain ratio or err
				if (deleted &#x3e; size || err) {
					self.<span class="apidocCodeKeywordSpan">_compact</span>(function (errCompact) {
						if (errCompact &#x26;&#x26; err)
							cb(errCompact);
						else {
							if (errCompact) console.log(err);
							cb();
						}
					});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype._ensureIds" id="apidoc.element.tingodb.tcoll.prototype._ensureIds">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_ensureIds
        <span class="apidocSignatureSpan">(obj)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_ensureIds = function (obj) {
	var self = this;
	_.each(obj, function (v,k) {
		if (k.length &#x3e;0) {
			if (k[0]==&#x27;$&#x27;)
				throw new Error(&#x22;key &#x22;+k+&#x22; must not start with &#x27;$&#x27;&#x22;);
			if (k.indexOf(&#x27;.&#x27;)!=-1)
				throw new Error(&#x22;key &#x22;+k+&#x22; must not contain &#x27;.&#x27;&#x22;);
		}
		if (_.isObject(v)) {
			if (v instanceof self._tdb.ObjectID) {
				if (v.id&#x3c;0) {
					v._persist(++self._id)
				}
			}
			else
				self._ensureIds(v)
		}
	})
	return obj;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		if (_.isObject(v)) {
			if (v instanceof self._tdb.ObjectID) {
				if (v.id&#x3c;0) {
					v._persist(++self._id)
				}
			}
			else
				self.<span class="apidocCodeKeywordSpan">_ensureIds</span>(v)
		}
	})
	return obj;
}


tcoll.prototype._unwrapTypes = function(obj) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype._find" id="apidoc.element.tingodb.tcoll.prototype._find">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_find
        <span class="apidocSignatureSpan">(query, fields, skip, limit, sort_, hint, arFields, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_find = function (query, fields, skip, limit, sort_, hint, arFields, cb) {
	var self = this;
	this._tq.add(function (cb) {
		self.__find(query, fields, skip, limit, sort_, hint, arFields, cb);
	}, false, cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	}
	if (self._count !== null) {
		process.nextTick(function () {
			cb(null, self._count);
		});
		return;
	}
	self._c.<span class="apidocCodeKeywordSpan">_find</span>(self._query, {}, 0, null, null, self._hint, self._arFields, safe.sure(
cb, function (data) {
		self._count = data.length;
		cb(null, self._count);
	}));
}

tcursor.prototype.setReadPreference = function (the, cb) {
	var self = this;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype._getFS" id="apidoc.element.tingodb.tcoll.prototype._getFS">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_getFS
        <span class="apidocSignatureSpan">(pos, unsafe, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_getFS = function (pos, unsafe, cb) {
	var self = this;
	var cached = self._cache.get(pos,unsafe);
	if (cached)
		return safe.back(cb,null,cached);
	var b1 = new Buffer(45);
	fs.read(self._fd, b1, 0, 45, pos, safe.trap_sure(cb, function (bytes, data) {
		var h1 = JSON.parse(data.toString());
		h1.o = parseInt(h1.o,10);
		h1.k = parseInt(h1.k,10);
		var b2 = new Buffer(h1.o);
		fs.read(self._fd,b2,0,h1.o,pos+45+2+h1.k, safe.trap_sure(cb, function (bytes, data) {
			var obj = self._unwrapTypes(JSON.parse(data.toString()));
			if (bytes &#x3c;= self._cmaxobj)
				self._cache.set(pos, obj);
			cb(null,obj);
		}))
	}))
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype._getM" id="apidoc.element.tingodb.tcoll.prototype._getM">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_getM
        <span class="apidocSignatureSpan">(pos, unsafe, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_getM = function (pos, unsafe, cb) {
	safe.back(cb,null,unsafe?this._mstore[pos-1]:this._tdb._cloneDeep(this._mstore[pos-1]));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype._putFS" id="apidoc.element.tingodb.tcoll.prototype._putFS">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_putFS
        <span class="apidocSignatureSpan">(item, remove, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_putFS = function (item, remove, cb) {
	var self = this;
	self._wq.add(function (cb) {
		var err = _.attempt(function () {
			item = self._ensureIds(item);
		});
		if (err) {
			err.errmsg = err.toString();
			return cb(err);
		}
		if (_.isUndefined(item._id))
			return cb(new Error(&#x22;Invalid object key (_id)&#x22;));
		item = self._wrapTypes(item);
		var sobj = new Buffer(remove?&#x22;&#x22;:JSON.stringify(item));
		item = self._unwrapTypes(item);
		var key = {_id:simplifyKey(item._id),_uid:self._id,_dt:(new Date()).valueOf()};
		if (remove) key._a = &#x22;del&#x22;;
		else {
			var hash = crypto.createHash(&#x27;md5&#x27;);
			hash.update(sobj, &#x27;utf8&#x27;);
			key._s = hash.digest(&#x27;hex&#x27;);
		}
		var skey = new Buffer(JSON.stringify(key));
		var zeros = &#x22;0000000000&#x22;;
		var lobj = sobj.length.toString();
		var lkey = skey.length.toString();
		lobj = zeros.substr(0,zeros.length - lobj.length)+lobj;
		lkey = zeros.substr(0,zeros.length - lkey.length)+lkey;
		var h1={k:lkey,o:lobj,v:&#x22;001&#x22;};
		var buf = new Buffer(JSON.stringify(h1)+&#x22;\n&#x22;+skey+&#x22;\n&#x22;+sobj+&#x22;\n&#x22;);

		// check index update
		if (item &#x26;&#x26; !remove) {
			err = _.attempt(function () {
				_.each(self._idx,function(v,k) {
					v.set(item,key._id,true);
				})
			});
			if (err) {
				err.errmsg = err.toString();
				return cb(err);
			}
		}

		safe.run(function (cb) {
			var rec = self._store[key._id];
			if (rec &#x26;&#x26; rec.sum == key._s) return safe.back(cb);
			fs.write(self._fd, buf, 0, buf.length, self._fsize, safe.sure(cb, function (written) {
				if (remove)
					delete self._store[key._id];
				else
					self._store[key._id] = { pos: self._fsize, sum: key._s };

				if (remove || sobj.length &#x3e; self._cmaxobj)
					self._cache.unset(self._fsize)
				else
					self._cache.set(self._fsize,item);
				self._fsize+=written;
				// randomly check for non exclusive file usage
				// which is growth of file that we are nor aware
				// randomly to avoid overhead
				if (self._check1==0) {
					this._check1 = Math.random()*100+1;
					fs.fstat(self._fd, safe.sure(cb, function (stat) {
						if (self._fsize!=stat.size)
							cb(new Error(&#x22;File size mismatch. Are you use db/collection exclusively?&#x22;))
						else
							cb()
					}))
				} else {
					self._check1--;
					cb();
				}
			}));
		},
		function () {
			// update index
			_.each(self._idx,function(v,k) {
				if (!remove)
					v.set(item,key._id);
				else
					v.del(item,key._id);
			})
			cb(null);
		});
	}, true, cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype._putM" id="apidoc.element.tingodb.tcoll.prototype._putM">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_putM
        <span class="apidocSignatureSpan">(item_, remove, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_putM = function (item_, remove, cb) {
	var item = this._tdb._cloneDeep(item_);
	var self = this;
	self._wq.add(function (cb) {
		var err = _.attempt(function () {
			item = self._ensureIds(item);
		});
		if (err) {
			err.errmsg = err.toString();
			return cb(err);
		}
		if (_.isUndefined(item._id))
			return cb(new Error(&#x22;Invalid object key (_id)&#x22;));

		var key = {_id:simplifyKey(item._id)};

		// check index update
		if (item &#x26;&#x26; !remove) {
			err = _.attempt(function () {
				_.each(self._idx,function(v,k) {
					v.set(item,key._id,true);
				});
			});

			if (err) {
				err.errmsg = err.toString();
				return cb(err);
			}
		}

		if (remove) {
			self._mstore[self._store[key._id].pos-1]=null;
			delete self._store[key._id];
		}
		else {
			if (self._store[key._id]) {
				self._mstore[self._store[key._id].pos-1] = item;
			} else {
				self._mstore.push(item);
				self._store[key._id] = {pos: self._mstore.length};
			}
		}

		// update index
		_.each(self._idx,function(v,k) {
			if (!remove)
				v.set(item,key._id);
			else
				v.del(item,key._id);
		})
		cb(null);
	}, true, cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype._refreshIndexes" id="apidoc.element.tingodb.tcoll.prototype._refreshIndexes">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_refreshIndexes
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_refreshIndexes = function (cb) {
	var self = this;
	_.each(self._idx,function(v, k) {
		v.clear();
	});
	safe.eachOfSeries(self._store, function (rec, k, cb) {
		self._get(rec.pos, false, safe.sure(cb, function (obj) {
			var id = simplifyKey(obj._id);
			_.each(self._idx,function(v, k) {
				v.set(obj, id);
			});
			cb();
		}));
	}, cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
						else {
							if (errCompact) console.log(err);
							cb();
						}
					});
				} else cb();
			}, function () {
				self.<span class="apidocCodeKeywordSpan">_refreshIndexes</span>(cb);
			});
		});
	});
	self.ensureIndex({_id: 1}, {name: &#x27;_id_&#x27;, unique: true}, cb);
};

tcoll.prototype.compactCollection = function (cb) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype._stop" id="apidoc.element.tingodb.tcoll.prototype._stop">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_stop
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_stop = function (cb) {
	var self = this;
	self._tq.add(function (cb) {
		// this will prevent any tasks processed on this instance
		self._tq._stoped = true;
		if (self._fd) {
			fs.close(self._fd,safe.sure(cb, function () {
				cb(null,true);
			}));
		} else
			cb(null,false);
	},true,cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

tdb.prototype.close = function (forceClose, cb) {
	var self = this;
	if (cb==null) cb = forceClose;
	cb = cb || function () {};
	// stop any further operations on current collections
	safe.eachOf(self._cols, function (c, k, cb) {
		c.<span class="apidocCodeKeywordSpan">_stop</span>(cb)
	}, safe.sure(cb, function () {
		// and clean list
		self._cols = Object.create ? Object.create(null) : {};
		this.openCalled = false;
		safe.back(cb,null,this);
	}))
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype._unwrapTypes" id="apidoc.element.tingodb.tcoll.prototype._unwrapTypes">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_unwrapTypes
        <span class="apidocSignatureSpan">(obj)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_unwrapTypes = function (obj) {
	var self = this;
	_.each(obj, function (v,k) {
		if (_.isObject(v)) {
			switch (v.$wrap) {
				case &#x22;$date&#x22;: obj[k] = new Date(v.v); break;
				case &#x22;$oid&#x22;:
					var oid = new self._tdb.ObjectID(v.v);
					obj[k]=oid;
				break;
				case &#x22;$bin&#x22;:
					var bin = new self._tdb.Binary(new Buffer(v.v, &#x27;base64&#x27;));
					obj[k] = bin;
				break;
				default: self._unwrapTypes(v);
			}
		}
	})
	return obj;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	var b1 = new Buffer(45);
	fs.read(self._fd, b1, 0, 45, pos, safe.trap_sure(cb, function (bytes, data) {
		var h1 = JSON.parse(data.toString());
		h1.o = parseInt(h1.o,10);
		h1.k = parseInt(h1.k,10);
		var b2 = new Buffer(h1.o);
		fs.read(self._fd,b2,0,h1.o,pos+45+2+h1.k, safe.trap_sure(cb, function (bytes, data) {
			var obj = self.<span class="apidocCodeKeywordSpan">_unwrapTypes</span>(JSON.parse(data.toString()));
			if (bytes &#x3c;= self._cmaxobj)
				self._cache.set(pos, obj);
			cb(null,obj);
		}))
	}))
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype._wrapTypes" id="apidoc.element.tingodb.tcoll.prototype._wrapTypes">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>_wrapTypes
        <span class="apidocSignatureSpan">(obj)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_wrapTypes = function (obj) {
	var self = this;
	_.each(obj, function (v,k) {
		if (_.isDate(v))
			obj[k] = {$wrap:&#x22;$date&#x22;,v:v.valueOf(),h:v}
		else if (v instanceof self._tdb.ObjectID)
			obj[k] = {$wrap:&#x22;$oid&#x22;,v:v.toJSON()}
		else if (v instanceof self._tdb.Binary)
			obj[k] = {$wrap: &#x22;$bin&#x22;, v: v.toJSON()};
		else if (_.isObject(v))
			self._wrapTypes(v)

	})
	return obj;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		if (_.isDate(v))
			obj[k] = {$wrap:&#x22;$date&#x22;,v:v.valueOf(),h:v}
		else if (v instanceof self._tdb.ObjectID)
			obj[k] = {$wrap:&#x22;$oid&#x22;,v:v.toJSON()}
		else if (v instanceof self._tdb.Binary)
			obj[k] = {$wrap: &#x22;$bin&#x22;, v: v.toJSON()};
		else if (_.isObject(v))
			self.<span class="apidocCodeKeywordSpan">_wrapTypes</span>(v)

	})
	return obj;
}

tcoll.prototype._ensureIds = function(obj) {
	var self = this;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.compactCollection" id="apidoc.element.tingodb.tcoll.prototype.compactCollection">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>compactCollection
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">compactCollection = function (cb) {
	var self = this;
	self._tq.add(function (cb) {
		self._compact(safe.sure(cb, function () {
			self._cache.clear();
			self._refreshIndexes(cb);
		}));
	}, true, cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	}));
};

tdb.prototype.compactDatabase = function (cb) {
	var self = this;
	self.collections(safe.sure(cb, function(collections) {
		safe.forEach(collections, function (c, cb) {
			c.<span class="apidocCodeKeywordSpan">compactCollection</span>(cb);
		},cb);
	}));
};

tdb.prototype.renameCollection = function (on,nn,opts,cb) {
	if (cb==null) {
		cb = opts;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.count" id="apidoc.element.tingodb.tcoll.prototype.count">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>count
        <span class="apidocSignatureSpan">(query, options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">count = function (query, options, cb) {
	var self = this;
	if (arguments.length == 1) {
		cb = arguments[0];
        options = null;
		query = null;
	}
	if (arguments.length == 2) {
        query = arguments[0];
		cb = arguments[1];
        options = null;
	}

	if (query==null || _.size(query)==0) {
		this._tq.add(function (cb) {
			cb(null, _.size(self._store));
		},false,cb);
	} else
		self.find(query, options).count(cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
							var query = &#x22;/rooms?homeid=&#x22;+homeId.toString();
							// dirty code to get simulated GET variable
							var getId = query.match(&#x22;homeid=(.*)&#x22;)[1];
							console.log(query, getId)
							// typical code to get id from external world
							// and use it for queries
							rooms.find({_idHome:new engine.ObjectID(getId)})
								.<span class="apidocCodeKeywordSpan">count</span>(function (err, count) {
									console.log(count);
									console.timeEnd(&#x22;sample&#x22;);
							})
						}
					})
				}
			})
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.createIndex" id="apidoc.element.tingodb.tcoll.prototype.createIndex">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>createIndex
        <span class="apidocSignatureSpan">(obj, options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">createIndex = function (obj, options, cb) {
	var self = this;
	if (_.isFunction(options)) {
		cb = options;
		options = {};
	}
	cb = cb || function () {};
	options = options || {};

	var c = new tcursor(this,{},{},{});
	c.sort(obj);
	if (c._err)
		return safe.back(cb,c._err);
	var key = c._sort;

	if (key===null)
		return safe.back(cb,new Error(&#x22;No fields are specified&#x22;));

	var index = self._idx[key];
	if (index)
		return safe.back(cb,null, index.name);

	// force array support when global option is set
	if (_.isUndefined(options._tiarr) &#x26;&#x26; self._tdb._gopts.searchInArray)
		options._tiarr = true;

	var name = options.name || _.map(key, function (v) { return v[0] + &#x27;_&#x27; + v[1]; }).join(&#x27;_&#x27;);
	index = new tindex(key, self, options, name);

	if (self._tq._tc==-1) {
		// if no operation is pending just register index
		self._idx[key] = index;
		safe.back(cb, null, index.name);
	}
	else {
		// overwise register index operation
		this._tq.add(function (cb) {
			var range = _.values(self._store);
			safe.forEachSeries(range, function (rec, cb) {
				self._get(rec.pos, false, safe.sure(cb, function (obj) {
					index.set(obj,simplifyKey(obj._id));
					cb();
				}));
			}, safe.sure(cb, function () {
				self._idx[key] = index;
				cb();
			}));
		}, true, function (err) {
			if (err) cb(err);
			else cb(null, index.name);
		});
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.drop" id="apidoc.element.tingodb.tcoll.prototype.drop">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>drop
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">drop = function (cb) {
	this._tdb.dropCollection(this._name,cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
				});

				// write results to collection
				safe.waterfall([
					function (cb) {
						self._tdb.collection(opts.out.replace, { strict: 1 }, function (err, col) {
							if (err) return cb(null, null);
							col.<span class="apidocCodeKeywordSpan">drop</span>(cb);
						});
					},
					function (arg, cb) {
						self._tdb.collection(opts.out.replace, {}, cb);
					},
					function (col, cb) {
						var docs = _.map(m, function (value, key) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.ensureIndex" id="apidoc.element.tingodb.tcoll.prototype.ensureIndex">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>ensureIndex
        <span class="apidocSignatureSpan">(obj, options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">ensureIndex = function (obj, options, cb) {
	var self = this;
	if (_.isFunction(options)) {
		cb = options;
		options = {};
	}
	cb = cb || function () {};
	options = options || {};

	var c = new tcursor(this,{},{},{});
	c.sort(obj);
	if (c._err)
		return safe.back(cb,c._err);
	var key = c._sort;

	if (key===null)
		return safe.back(cb,new Error(&#x22;No fields are specified&#x22;));

	var index = self._idx[key];
	if (index)
		return safe.back(cb,null, index.name);

	// force array support when global option is set
	if (_.isUndefined(options._tiarr) &#x26;&#x26; self._tdb._gopts.searchInArray)
		options._tiarr = true;

	var name = options.name || _.map(key, function (v) { return v[0] + &#x27;_&#x27; + v[1]; }).join(&#x27;_&#x27;);
	index = new tindex(key, self, options, name);

	if (self._tq._tc==-1) {
		// if no operation is pending just register index
		self._idx[key] = index;
		safe.back(cb, null, index.name);
	}
	else {
		// overwise register index operation
		this._tq.add(function (cb) {
			var range = _.values(self._store);
			safe.forEachSeries(range, function (rec, cb) {
				self._get(rec.pos, false, safe.sure(cb, function (obj) {
					index.set(obj,simplifyKey(obj._id));
					cb();
				}));
			}, safe.sure(cb, function () {
				self._idx[key] = index;
				cb();
			}));
		}, true, function (err) {
			if (err) cb(err);
			else cb(null, index.name);
		});
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
##### searchInArray: true|false Default is false

Globally enables support of search in nested arrays. MongoDB supports this unconditionally. For TingoDB, searching arrays when there
 are no arrays incurs a performance penalty. That&#x27;s why this is switched off by default.
Additionally, and this might be a better approach, nested array support can be enabled for individual indexes or search queries.

To enable nested arrays in individual indexed, use &#x22;_tiarr:true&#x22; option.

	self._cash_transactions.<span class="apidocCodeKeywordSpan">ensureIndex</span>(&#x22;splits.accountId&#x22;,{_tiarr:true},cb);

To enable nested arrays in individual queries for fields that do not use indexes, use &#x22;_tiarr.&#x22; to prefix field names.

	coll.find({&#x27;arr.num&#x27;:10},{&#x22;_tiar.arr.num&#x22;:0})

####  new Db(path, options)
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.find" id="apidoc.element.tingodb.tcoll.prototype.find">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>find
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">find = function () {
	var cb = null, query = {}, opts = {}, fields = null, skip = null, limit = null, sort = null;
	var argc = arguments.length;
	if (argc&#x3e;0) {
		// guess callback, it is always latest
		cb = arguments[argc-1];
		if (!_.isFunction(cb))
			cb=null
		else
			argc--;
		if (argc&#x3e;0) {
			// query should always exist
			query = arguments[0]
			if (argc&#x3e;1) {
				if (argc==2) {
					var val = arguments[1];
					// worst case we get either options either fiels
					if (_(val).keys().intersection(findOpts).size() &#x3e; 0)
						opts = val
					else
						fields = val;
				} else {
					fields = arguments[1];
					if (argc == 3)
						opts = arguments[2]
					else {
						skip = arguments[2];
						limit = arguments[3]
					}
				}
			}
		}
	}

	opts = opts || {};
	skip = skip || opts.skip || null;
	limit = limit || opts.limit || null;
	fields = fields || opts.fields || null;
	sort = sort || opts.sort || null;


	var c = new tcursor(this,query, fields, opts);

	if (skip) c.skip(skip);
	if (limit) c.limit(limit);
	if (sort) c.sort(sort);
	if (cb)
		cb(null, c)
	else
		return c;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

To enable nested arrays in individual indexed, use &#x22;_tiarr:true&#x22; option.

	self._cash_transactions.ensureIndex(&#x22;splits.accountId&#x22;,{_tiarr:true},cb);

To enable nested arrays in individual queries for fields that do not use indexes, use &#x22;_tiarr.&#x22; to prefix field names.

	coll.<span class="apidocCodeKeywordSpan">find</span>({&#x27;arr.num&#x27;:10},{&#x22;_tiar.arr.num&#x22;:0})

####  new Db(path, options)

The only required parameter is the database path. It should be a valid path to an empty folder or a folder that already contains
 collection files.

API extensions
==============
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.findAndModify" id="apidoc.element.tingodb.tcoll.prototype.findAndModify">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>findAndModify
        <span class="apidocSignatureSpan">(query, sort, doc, opts, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">findAndModify = function (query, sort, doc, opts, cb) {
	var self = this;
	if (_.isFunction(opts) &#x26;&#x26; cb == null) {
		cb = opts;
		opts = {};
	}
	opts = opts || {};
	doc = doc || {};

	var updater = new Updater(doc, self._tdb);
	var $doc = updater.hasAtomic()?null:doc;

	var c = new tcursor(this,{}, opts.fields || {},{});
	c.sort(sort);
	if (c._err)
		return safe.back(cb,c._err);

	this._tq.add(function (cb) {
		self.__find(query, null, 0, 1, c._sort, opts.hint, {}, safe.sure(cb, function (res) {
			if (res.length==0) {
				if (opts.upsert) {
					$doc = $doc || query;
					$doc = self._tdb._cloneDeep($doc);
					updater.update($doc,true);
					if (_.isUndefined($doc._id))
						$doc._id = new self._tdb.ObjectID();
					self._put($doc, false, safe.sure(cb, function () {
						cb(null,opts.new?c._projectFields($doc):{})
					}))
				} else
					cb();
			} else {
				self._get(res[0], false, safe.sure(cb, function (obj) {
					var robj = (opts.new &#x26;&#x26; !opts.remove) ? obj : self._tdb._cloneDeep(obj);
					// remove current version of doc from indexes
					_.each(self._idx,function(v,k) {
						v.del(obj,simplifyKey(obj._id));
					})
					var udoc = $doc;
					if (!$doc) {
						udoc = obj;
						updater.update(udoc);
					}
					udoc._id = obj._id;
					// put will add it back to indexes
					self._put(udoc, opts.remove?true:false, safe.sure(cb,function () {
						cb(null,c._projectFields(robj))
					}))
				}))
			}
		}))
	},true,cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.findAndRemove" id="apidoc.element.tingodb.tcoll.prototype.findAndRemove">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>findAndRemove
        <span class="apidocSignatureSpan">(query, sort, opts, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">findAndRemove = function (query, sort, opts, cb) {
	var self = this;

	if (_.isFunction(sort) &#x26;&#x26; cb == null &#x26;&#x26; opts==null) {
		cb = sort;
		sort = {}
		opts = {};
	} else if (_.isFunction(opts) &#x26;&#x26; cb == null) {
		cb = opts;
		opts = {};
	}
	opts = opts || {};
	sort = sort || {};

	var c = new tcursor(this,{},{},{});

	// Fix for mongoouse/tungus they pass sort as undefined
	c.sort(sort);

	if (c._err)
		return safe.back(cb,c._err);

	this._tq.add(function (cb) {
		self.__find(query, null, 0, 1, c._sort, opts.hint, {}, safe.sure(cb, function (res) {
			if (res.length==0)
				return cb();
			self._get(res[0], false, safe.sure(cb, function (obj) {
				self._put(obj,true,safe.sure(cb, function () {
					cb(null,obj);
				}))
			}))
		}))
	},true,cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.findOne" id="apidoc.element.tingodb.tcoll.prototype.findOne">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>findOne
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">findOne = function () {
  var args = arguments,
      index = -1,
      length = nativeMax(args.length - start, 0),
      array = Array(length);

  while (++index &#x3c; length) {
    array[index] = args[start + index];
  }
  switch (start) {
    case 0: return func.call(this, array);
    case 1: return func.call(this, args[0], array);
    case 2: return func.call(this, args[0], args[1], array);
  }
  var otherArgs = Array(start + 1);
  index = -1;
  while (++index &#x3c; start) {
    otherArgs[index] = args[index];
  }
  otherArgs[start] = array;
  return apply(func, this, otherArgs);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var db = new Db(&#x27;test&#x27;, new Server(&#x27;localhost&#x27;, 27017));
var collection = db.collection(&#x22;batch_document_insert_collection_safe&#x22;);
collection.insert([{hello:&#x27;world_safe1&#x27;}
  , {hello:&#x27;world_safe2&#x27;}], {w:1}, function(err, result) {
  assert.equal(null, err);

  collection.<span class="apidocCodeKeywordSpan">findOne</span>({hello:&#x27;world_safe2&#x27;}, function(err, item) {
	assert.equal(null, err);
	assert.equal(&#x27;world_safe2&#x27;, item.hello);
  })
});
```

The same example using TingoDB is as follows:
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.group" id="apidoc.element.tingodb.tcoll.prototype.group">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>group
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">group = function () {
  var args = arguments,
      index = -1,
      length = nativeMax(args.length - start, 0),
      array = Array(length);

  while (++index &#x3c; length) {
    array[index] = args[start + index];
  }
  switch (start) {
    case 0: return func.call(this, array);
    case 1: return func.call(this, args[0], array);
    case 2: return func.call(this, args[0], args[1], array);
  }
  var otherArgs = Array(start + 1);
  index = -1;
  while (++index &#x3c; start) {
    otherArgs[index] = args[index];
  }
  otherArgs[start] = array;
  return apply(func, this, otherArgs);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.indexExists" id="apidoc.element.tingodb.tcoll.prototype.indexExists">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>indexExists
        <span class="apidocSignatureSpan">(idx, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">indexExists = function (idx, cb) {
	if (!_.isArray(idx))
		idx = [idx];
	var i = _.intersection(idx,_(this._idx).values().map(&#x27;name&#x27;).value());
	cb(null,i.length == idx.length);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.indexes" id="apidoc.element.tingodb.tcoll.prototype.indexes">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>indexes
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">indexes = function (cb) {
	var self = this;
	this._tq.add(function (cb) {
		cb(null, _.values(self._idx));
	},false,cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.initFS" id="apidoc.element.tingodb.tcoll.prototype.initFS">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>initFS
        <span class="apidocSignatureSpan">(tdb, name, options, create, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">initFS = function (tdb, name, options, create, cb) {
	var self= this;
	this._tdb = tdb;
	this._cache = new tcache(tdb, tdb._gopts.cacheSize);
	this._cmaxobj = tdb._gopts.cacheMaxObjSize || 1024;
	this.collectionName = this._name = name;
	this._filename = path.join(this._tdb._path, this._name);
	if (options.strict) {
		var exists = fs.existsSync(self._filename);
		if (exists &#x26;&#x26; create) return cb(new Error(&#x22;Collection &#x22; + self._name + &#x22; already exists. Currently in safe mode.&#x22;));
		else if (!exists &#x26;&#x26; !create) return cb(new Error(&#x22;Collection &#x22; + self._name + &#x22; does not exist. Currently in safe mode.&#x22;));
	}
	var pos = 0;
	var deleted = 0;
	var found = 0;
	this._tq = new wqueue(100, function (cb) {
		safe.run(function (cb) {
			fs.open(self._filename, &#x22;a+&#x22;, safe.sure(cb, function (fd) {
			self._fd = fd;
			var b1 = new Buffer(45);
			safe.whilst(function () { return self._fsize === null; }, function(cb) {
				safe.run(function (cb) {
					fs.read(fd, b1, 0, 45, pos, safe.trap_sure(cb, function (bytes, data) {
						if (bytes===0) {
							self._fsize = pos;
							return cb();
						}
						var h1 = JSON.parse(data.toString());
						h1.o = parseInt(h1.o,10);
						h1.k = parseInt(h1.k,10);
						var b2 = new Buffer(h1.k);
						fs.read(fd,b2,0,h1.k,pos+45+1, safe.sure(cb, function (bytes, data) {
							var k = JSON.parse(data.toString());
							self._id = k._uid;
							if (k._a==&#x27;del&#x27;) {
								delete self._store[k._id];
								deleted++;
							} else {
								if (self._store[k._id]) deleted++;
								self._store[k._id] = { pos: pos, sum: k._s };
							}
							pos+=45+3+h1.o+h1.k;
							found++;
							cb();
						}));
					}));
				}, function (err) {
					if (err)
						cb(new Error(self._name+&#x22;: Error during load - &#x22;+err.toString()));
					else
						cb();
				});
			}, cb);
			}));
		}, function (err) {
			if (!found &#x26;&#x26; err)
				return cb(err); // nothing read and error, just rise it

			safe.run(function (cb) {
				var size = _.size(self._store);
				// autocompact on certain ratio or err
				if (deleted &#x3e; size || err) {
					self._compact(function (errCompact) {
						if (errCompact &#x26;&#x26; err)
							cb(errCompact);
						else {
							if (errCompact) console.log(err);
							cb();
						}
					});
				} else cb();
			}, function () {
				self._refreshIndexes(cb);
			});
		});
	});
	self.ensureIndex({_id: 1}, {name: &#x27;_id_&#x27;, unique: true}, cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.initM" id="apidoc.element.tingodb.tcoll.prototype.initM">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>initM
        <span class="apidocSignatureSpan">(tdb, name, options, create, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">initM = function (tdb, name, options, create, cb) {
	var self= this;
	this._tdb = tdb;
	tdb._mstore = tdb._mstore || Object.create ? Object.create(null) : {};
	this.collectionName = this._name = name;
	if (options.strict) {
		var exists = tdb._mstore[name];
		if (exists &#x26;&#x26; create) return cb(new Error(&#x22;Collection &#x22; + self._name + &#x22; already exists. Currently in safe mode.&#x22;));
		else if (!exists &#x26;&#x26; !create) return cb(new Error(&#x22;Collection &#x22; + self._name + &#x22; does not exist. Currently in safe mode.&#x22;));
	}
	tdb._mstore[name] = this._mstore = tdb._mstore[name] || [];
	for (var k=0; k&#x3c; this._mstore.length; k++) {
		var o = this._mstore[k];
		if (o) {
			self._store[simplifyKey(o._id)]={pos:k+1};
		}
	}
	this._tq = new wqueue(100, function (cb) {
		// update indexes
		safe.eachOfSeries(self._store, function (rec, k, cb) {
			self._get(rec.pos, false, safe.sure(cb, function (obj) {
				var id = simplifyKey(obj._id);
				_.each(self._idx,function(v, k) {
					v.set(obj, id);
				});
				cb();
			}));
		}, cb);
	});
	self.ensureIndex({_id: 1}, {name: &#x27;_id_&#x27;, unique: true}, cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.insert" id="apidoc.element.tingodb.tcoll.prototype.insert">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>insert
        <span class="apidocSignatureSpan">(docs, opts, cb )</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">insert = function (docs, opts, cb ) {
	var self = this;
	if (_.isFunction(opts) &#x26;&#x26; cb == null) {
		cb = opts;
		opts = {};
	}
	opts = opts || {};
	if (opts.w&#x3e;0 &#x26;&#x26; !_.isFunction(cb))
		throw new Error(&#x22;Callback is required for safe update&#x22;);
	cb = cb || function () {};
	if (!_.isArray(docs))
		docs = [docs];
	this._tq.add(function (cb) {
		safe.forEachSeries(docs, function (doc, cb) {
			if (_.isUndefined(doc._id)) {
				doc._id = new self._tdb.ObjectID();
			}
			self._put(doc, false, cb);
		}, safe.sure(cb, function () {
			cb(null, docs);
		}))
	}, true, cb)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
```javascript
var Db = require(&#x27;mongodb&#x27;).Db,
	Server = require(&#x27;mongodb&#x27;).Server,
	assert = require(&#x27;assert&#x27;);

var db = new Db(&#x27;test&#x27;, new Server(&#x27;localhost&#x27;, 27017));
var collection = db.collection(&#x22;batch_document_insert_collection_safe&#x22;);
collection.<span class="apidocCodeKeywordSpan">insert</span>([{hello:&#x27;world_safe1&#x27;}
, {hello:&#x27;world_safe2&#x27;}], {w:1}, function(err, result) {
assert.equal(null, err);

collection.findOne({hello:&#x27;world_safe2&#x27;}, function(err, item) {
	assert.equal(null, err);
	assert.equal(&#x27;world_safe2&#x27;, item.hello);
})
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.mapReduce" id="apidoc.element.tingodb.tcoll.prototype.mapReduce">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>mapReduce
        <span class="apidocSignatureSpan">(map, reduce, opts, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">mapReduce = function (map, reduce, opts, cb) {
	var self = this;
	if (_.isFunction(opts)) {
		cb = opts;
		opts = {};
	}

	if (!opts.out) return safe.back(cb, new Error(&#x27;the out option parameter must be defined&#x27;));
	if (!opts.out.inline &#x26;&#x26; !opts.out.replace) {
		return safe.back(cb, new Error(&#x27;the only supported out options are inline and replace&#x27;));
	}

	code2fn(opts.scope);

	var m = {};

	function emit(k, v) {
		var values = m[k];
		if (!values) m[k] = [ v ];
		else {
			values.push(v);
			if (values.length &#x3e; 1000) values = [ reduce(k, values) ];
		}
	}

	with (opts.scope || {}) {
		try {
			if (map instanceof Code) {
				with (map.scope) {
					map = eval(&#x27;(&#x27; + map.code + &#x27;)&#x27;);
				}
			} else map = eval(&#x27;(&#x27; + map + &#x27;)&#x27;);
			if (reduce instanceof Code) {
				with (reduce.scope) {
					reduce = eval(&#x27;(&#x27; + reduce.code + &#x27;)&#x27;);
				}
			} else reduce = eval(&#x27;(&#x27; + reduce + &#x27;)&#x27;);
			if (finalize instanceof Code) {
				with (finalize.scope) {
					finalize = eval(&#x27;(&#x27; + finalize.code + &#x27;)&#x27;);
				}
			} else var finalize = eval(&#x27;(&#x27; + opts.finalize + &#x27;)&#x27;);
		} catch (e) {
			return safe.back(cb,e);
		}
	}

	self.find(opts.query, null, { limit: opts.limit, sort: opts.sort }, safe.sure(cb, function (c) {
		var doc;
		safe.doUntil(
			function (cb) {
				c.nextObject(safe.trap_sure(cb, function (_doc) {
					doc = _doc;
					if (doc) map.call(doc);
					return cb();
				}));
			},
			function () {
				return doc === null;
			},
			safe.trap_sure(cb, function () {
				_.each(m,function (v, k) {
					v = v.length &#x3e; 1 ? reduce(k, v) : v[0];
					if (finalize) v = finalize(k, v);
					m[k] = v;
				});

				var stats = {};
				if (opts.out.inline) return process.nextTick(function () {
					cb(null, _.values(m), stats); // execute outside of trap
				});

				// write results to collection
				safe.waterfall([
					function (cb) {
						self._tdb.collection(opts.out.replace, { strict: 1 }, function (err, col) {
							if (err) return cb(null, null);
							col.drop(cb);
						});
					},
					function (arg, cb) {
						self._tdb.collection(opts.out.replace, {}, cb);
					},
					function (col, cb) {
						var docs = _.map(m, function (value, key) {
							return {
								_id: key,
								value: value
							};
						});
						col.insert(docs, safe.sure(cb, function () {
							if (opts.verbose) cb(null, col, stats);
							else cb(null, col);
						}));
					}
				], cb);
			}
		)); // doUntil
	}));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.remove" id="apidoc.element.tingodb.tcoll.prototype.remove">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>remove
        <span class="apidocSignatureSpan">(query, opts, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">remove = function (query, opts, cb) {
	var self = this;
	if (_.isFunction(query)) {
		cb = query;
		query = opts = {};
	} else if (_.isFunction(opts)) {
		cb = opts;
		opts = {};
	}
	opts = opts || {};
	if (opts.w&#x3e;0 &#x26;&#x26; !_.isFunction(cb))
		throw new Error(&#x22;Callback is required&#x22;);
	cb = cb || function () {};
	var single = opts.single || false;
	this._tq.add(function (cb) {
		self.__find(query, null, 0, single ? 1 : null, null, opts.hint, {}, safe.sure(cb, function (res) {
			safe.forEachSeries(res, function (pos, cb) {
				self._get(pos, false, safe.sure(cb, function (obj) {
					self._put(obj,true,cb);
				}))
			}, safe.sure(cb, function () {
				cb(null,res.length);
			}))
		}))
	},true,cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.rename" id="apidoc.element.tingodb.tcoll.prototype.rename">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>rename
        <span class="apidocSignatureSpan">(nname, opts, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">rename = function (nname, opts, cb) {
	var self = this;
	if (_.isFunction(opts)) {
		cb = opts;
		opts = {};
	}
	var err = self._tdb._nameCheck(nname);
	if (err)
		return safe.back(cb,err);
	if (self._tdb._stype==&#x22;mem&#x22;) {
		delete self._tdb._cols[self._name];
		self._tdb._cols[nname] = self;
		delete self._tdb._mstore[self._name];
		self._tdb._mstore[nname] = self._mstore;
		safe.back(cb,null);
	} else {
		self._tq.add(function (cb) {
			fs.rename(path.join(self._tdb._path,self._name),path.join(self._tdb._path,nname),safe.sure(cb, function () {
				delete self._tdb._cols[self._name];
				self._tdb._cols[nname] = self;
				self.collectionName = self._name = nname;
				cb();
			}));
		},true,cb);
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
			}
			if (!!process.platform.match(/^win/)) {
				// WINDOWS: unsafe because if something fail while renaming file it will not
				// restore automatically
				fs.close(self._fd, safe.sure(cb,function() {
					fs.close(fd, safe.sure(cb,function() {
						fs.unlink(self._filename, safe.sure(cb,function () {
							fs.<span class="apidocCodeKeywordSpan">rename</span>(filename, self._filename, safe.sure(cb, function () {
								fs.open(self._filename, &#x27;a+&#x27;, safe.sure(cb, function (fd) {
									self._fd = fd;
									self._fsize = wpos;
									self._store = store;
									cb();
								}));
							}));
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.save" id="apidoc.element.tingodb.tcoll.prototype.save">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>save
        <span class="apidocSignatureSpan">(doc, opts, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">save = function (doc, opts, cb) {
	var self = this;
	cb = _.isFunction(doc)?doc:_.isFunction(opts)?opts:cb;
	cb = cb || function () {};
	doc = doc || {};
	opts = opts || {};
	this._tq.add(function (cb) {
		var res = doc;
		(function(cb) {
			if (_.isUndefined(doc._id)) {
				doc._id = new self._tdb.ObjectID();
				cb()
			} else {
				var id = simplifyKey(doc._id);
				var pos = self._store[id];
				// check if document with this id already exist
				if (pos) {
					// if so we need to fetch it to update index
					self._get(pos.pos, false, safe.sure(cb, function (oldDoc) {
						// remove current version of doc from indexes
						_.each(self._idx,function(v,k) {
							v.del(oldDoc,id);
						})
						res = 1;
						cb();
					}))
				} else cb();
			}
		})(safe.sure(cb, function () {
			self._put(doc, false, safe.sure(cb, function () {
				cb(null,res); // when update return 1 when new save return obj
			}))
		}))
	},true,cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.stats" id="apidoc.element.tingodb.tcoll.prototype.stats">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>stats
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">stats = function (cb) {
	var self = this;
	this._tq.add(function (cb) {
		cb(null, {count:_.size(self._store)});
	},false,cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcoll.prototype.update" id="apidoc.element.tingodb.tcoll.prototype.update">
        function <span class="apidocSignatureSpan">tingodb.tcoll.prototype.</span>update
        <span class="apidocSignatureSpan">(query, doc, opts, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">update = function (query, doc, opts, cb) {
	var self = this;
	if (_.isFunction(opts) &#x26;&#x26; cb == null) {
		cb = opts;
	}
	opts = opts || {};
	if (opts.w&#x3e;0 &#x26;&#x26; !_.isFunction(cb))
		throw new Error(&#x22;Callback is required for safe update&#x22;);
	cb = cb || function () {}
	if (!_.isObject(query))
		throw new Error(&#x22;selector must be a valid JavaScript object&#x22;);
	if (!_.isObject(doc))
		throw new Error(&#x22;document must be a valid JavaScript object&#x22;);

	var multi = opts.multi || false;
    var updater = new Updater(doc, self._tdb);
	var $doc = updater.hasAtomic()?null:doc;
	this._tq.add(function (cb) {
		self.__find(query, null, 0, multi ? null : 1, null, opts.hint, {}, safe.sure(cb, function (res) {
			if (res.length==0) {
				if (opts.upsert) {
					$doc = $doc || query;
					$doc = self._tdb._cloneDeep($doc);
					updater.update($doc,true);
					if (_.isUndefined($doc._id))
						$doc._id = new self._tdb.ObjectID();
					self._put($doc, false, safe.sure(cb, function () {
						cb(null, 1,{updatedExisting:false,upserted:$doc._id,n:1})
					}))
				} else
					cb(null,0);
			} else {
				safe.forEachSeries(res, function (pos, cb) {
					self._get(pos, false, safe.sure(cb, function (obj) {
						// remove current version of doc from indexes
						_.each(self._idx,function(v,k) {
							v.del(obj,simplifyKey(obj._id));
						})
						var udoc = $doc;
						if (!$doc) {
							udoc = obj;
							updater.update(udoc);
						}
						udoc._id = obj._id;
						// put will add it back to indexes
						self._put(udoc, false, cb);
					}))
				}, safe.sure(cb,function () {
					cb(null, res.length, {updatedExisting:true,n:res.length});
				}))
			}
		}))
	},true,cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		item = self._wrapTypes(item);
		var sobj = new Buffer(remove?&#x22;&#x22;:JSON.stringify(item));
		item = self._unwrapTypes(item);
		var key = {_id:simplifyKey(item._id),_uid:self._id,_dt:(new Date()).valueOf()};
		if (remove) key._a = &#x22;del&#x22;;
		else {
			var hash = crypto.createHash(&#x27;md5&#x27;);
			hash.<span class="apidocCodeKeywordSpan">update</span>(sobj, &#x27;utf8&#x27;);
			key._s = hash.digest(&#x27;hex&#x27;);
		}
		var skey = new Buffer(JSON.stringify(key));
		var zeros = &#x22;0000000000&#x22;;
		var lobj = sobj.length.toString();
		var lkey = skey.length.toString();
		lobj = zeros.substr(0,zeros.length - lobj.length)+lobj;
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.tcursor" id="apidoc.module.tingodb.tcursor">module tingodb.tcursor</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tcursor.tcursor" id="apidoc.element.tingodb.tcursor.tcursor">
        function <span class="apidocSignatureSpan">tingodb.</span>tcursor
        <span class="apidocSignatureSpan">(tcoll, query, fields, opts)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function tcursor(tcoll, query, fields, opts) {
	var self = this;
	this.INIT = 0;
	this.OPEN = 1;
	this.CLOSED = 2;
	this.GET_MORE = 3;
	this._query = query;
	this._c = tcoll;
	this._i = 0;
	this._skip = 0;
	this._limit = null;
	this._count = null;
	this._items = null;
	this._sort = null;
	this._hint = opts.hint;
	this._arFields = Object.create ? Object.create(null) : {};
	this._fieldsType = null;
	this._fieldsExcludeId = false;
	this._fields = Object.create ? Object.create(null) : {};
	this.timeout = _.isUndefined(opts.timeout)?true:opts.timeout;

	_.each(fields, function (v,k) {
		if (!k &#x26;&#x26; _.isString(v)) {
			k=v; v = 1;
		}
		if (v == 0 || v==1) {
			// _id treated specially
			if (k==&#x22;_id&#x22; &#x26;&#x26; v==0) {
				self._fieldsExcludeId = true;
				return;
			}

			if (self._fieldsType==null)
				self._fieldsType = v;
			if (self._fieldsType==v) {
				if (k.indexOf(&#x22;_tiar.&#x22;)==0)
					self._arFields[k.substr(6)]=1;
				else
					self._fields[k]=v;
			} else if (!self._err)
				self._err = new Error(&#x22;Mixed set of projection options (0,1) is not valid&#x22;);
		} else if (!self._err)
			self._err = new Error(&#x22;Unsupported projection option: &#x22;+JSON.stringify(v));
	})
	// _id treated specially
	if ((self._fieldsType===0 || self._fieldsType===null) &#x26;&#x26; self._fieldsExcludeId) {
		self._fieldsType = 0;
		self._fields[&#x27;_id&#x27;]=0;
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.tcursor.prototype" id="apidoc.module.tingodb.tcursor.prototype">module tingodb.tcursor.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype._ensure" id="apidoc.element.tingodb.tcursor.prototype._ensure">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>_ensure
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_ensure = function (cb) {
	var self = this;
	if (self._items!=null)
		return process.nextTick(cb);
	self._c._find(self._query, {}, self._skip, self._limit, self._sort, self._hint, self._arFields, safe.sure_result(cb, function (
data) {
		self._items = data;
		self._i=0;
	}))
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

tcursor.prototype.nextObject = function (cb) {
	var self = this;
	if (self._err) {
		if (cb) process.nextTick(function () {cb(self._err)})
		return;
	}
	self.<span class="apidocCodeKeywordSpan">_ensure</span>(safe.sure(cb, function () {
		if (self._i&#x3e;=self._items.length)
			return cb(null, null);
		self._get(self._items[self._i], cb)
		self._i++;
	}))
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype._get" id="apidoc.element.tingodb.tcursor.prototype._get">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>_get
        <span class="apidocSignatureSpan">(pos, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_get = function (pos, cb) {
	var self = this;
	self._c._get(pos, false, safe.sure(cb, function (obj) {
		cb(null,self._projectFields(obj))
	}))
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var ops = {
	$range : function () {
		this.op = &#x22;$range&#x22;;
		this.dump = function () {
			return this._args[0].dump() +&#x22; in range (&#x22; +this._args[1].dump()+&#x22;,&#x22;+this._args[2].dump()+&#x22;,&#x22;+this
._args[3].dump()+&#x22;,&#x22;+this._args[4].dump()+&#x22;)&#x22;;
		},
		this._index = function (index) {
			if (index.order &#x3e; 0) return index.range(this._args[1].<span class="apidocCodeKeywordSpan">_get</span>(), this._args[2]._get
(), this._args[3]._get(), this._args[4]._get());
			else return index.range(this._args[2]._get(), this._args[1]._get(), this._args[4]._get(), this._args[3]._get());
		}
	},

	$lt : function () {
		this.op = &#x22;$lt&#x22;;
		this._index = function (index) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype._projectFields" id="apidoc.element.tingodb.tcursor.prototype._projectFields">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>_projectFields
        <span class="apidocSignatureSpan">(obj)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_projectFields = function (obj) {
	var self = this;
	if (self._fieldsType!=null) {
		if (self._fieldsType==0) {
			applyProjectionDel(obj,self._fields)
		}
		else
			obj = applyProjectionGet(obj, self._fields,self._fieldsExcludeId?{}:{_id:obj._id})
	}
	return obj;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
				if (opts.upsert) {
					$doc = $doc || query;
					$doc = self._tdb._cloneDeep($doc);
					updater.update($doc,true);
					if (_.isUndefined($doc._id))
						$doc._id = new self._tdb.ObjectID();
					self._put($doc, false, safe.sure(cb, function () {
						cb(null,opts.new?c.<span class="apidocCodeKeywordSpan">_projectFields</span>($doc):{})
					}))
				} else
					cb();
			} else {
				self._get(res[0], false, safe.sure(cb, function (obj) {
					var robj = (opts.new &#x26;&#x26; !opts.remove) ? obj : self._tdb._cloneDeep(obj);
					// remove current version of doc from indexes
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype.batchSize" id="apidoc.element.tingodb.tcursor.prototype.batchSize">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>batchSize
        <span class="apidocSignatureSpan">(v, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">batchSize = function (v, cb) {
	var self = this;
	if (!_.isFinite(v)) {
		self._err = new Error(&#x22;batchSize requires an integer&#x22;);
		if (!cb) throw self._err;
	}
	if (self._i!=0) {
		self._err = new Error(&#x27;Cursor is closed&#x27;);
		if (!cb) throw self._err;
	}
	if (cb) process.nextTick(function () {cb(self._err,self)})
	return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype.close" id="apidoc.element.tingodb.tcursor.prototype.close">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>close
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">close = function (cb) {
	var self = this;
	this._items = [];
	this._i=-1;
	this._err = null;
	if (cb)
		process.nextTick(function () {cb(self._err,self)})
	return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
					store[k] = { pos: wpos, sum: rec.sum };
					wpos += data.length;
					cb();
				}));
			}));
		}, function (err) {
			if (err) {
				fs.<span class="apidocCodeKeywordSpan">close</span>(fd, function () {
					fs.unlink(filename, function () {
						cb(err);
					});
				});
				return;
			}
			if (!!process.platform.match(/^win/)) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype.count" id="apidoc.element.tingodb.tcursor.prototype.count">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>count
        <span class="apidocSignatureSpan">(applySkipLimit, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">count = function (applySkipLimit, cb) {
	var self = this;
	if (!cb) {
		cb = applySkipLimit;
		applySkipLimit = false;
	}
	if (self._err) {
		if (cb) process.nextTick(function () {cb(self._err)})
		return;
	}
	if ((!self._skip &#x26;&#x26; self._limit === null) || applySkipLimit) {
		self._ensure(safe.sure(cb, function () {
			cb(null, self._items.length);
		}));
		return;
	}
	if (self._count !== null) {
		process.nextTick(function () {
			cb(null, self._count);
		});
		return;
	}
	self._c._find(self._query, {}, 0, null, null, self._hint, self._arFields, safe.sure(cb, function (data) {
		self._count = data.length;
		cb(null, self._count);
	}));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
							var query = &#x22;/rooms?homeid=&#x22;+homeId.toString();
							// dirty code to get simulated GET variable
							var getId = query.match(&#x22;homeid=(.*)&#x22;)[1];
							console.log(query, getId)
							// typical code to get id from external world
							// and use it for queries
							rooms.find({_idHome:new engine.ObjectID(getId)})
								.<span class="apidocCodeKeywordSpan">count</span>(function (err, count) {
									console.log(count);
									console.timeEnd(&#x22;sample&#x22;);
							})
						}
					})
				}
			})
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype.each" id="apidoc.element.tingodb.tcursor.prototype.each">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>each
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">each = function (cb) {
	if (!_.isFunction(cb))
		throw new Error(&#x27;Callback is required&#x27;);

	var self = this;

	if (self.isClosed())
		self._err = new Error(&#x22;Cursor is closed&#x22;);

	if (self._err) {
		if (cb) process.nextTick(function () {cb(self._err)})
		return;
	}
	self._ensure(safe.sure(cb, function () {
		safe.forEachSeries(self._i!=0?self._items.slice(self._i,self._items.length):self._items, function (pos,cb1) {
			self._get(pos, safe.sure(cb, function (obj) {
				cb(null,obj)
				cb1();
			}))
		}, safe.sure(cb, function () {
			self._i=self._items.length;
			cb(null, null);
		}))
	}))
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
			tempset[this.id].push(this);
	}
}

ObjectID.prototype._persist = function (v) {
	var oldid = this.id;
	if (oldid&#x3c;0) {
		_.<span class="apidocCodeKeywordSpan">each</span>(tempset[oldid], function (oid) {
			oid.id = v;
		});
		delete tempset[oldid];
	}
}

ObjectID.prototype._init = function (val) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype.isClosed" id="apidoc.element.tingodb.tcursor.prototype.isClosed">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>isClosed
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">isClosed = function () {
	if (!this._items)
		return false;
	return this._i==-1 || this._i&#x3e;=this._items.length;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}

tcursor.prototype.toArray = function (cb) {
	if (!_.isFunction(cb))
		throw new Error(&#x27;Callback is required&#x27;);
	var self = this;

	if (self.<span class="apidocCodeKeywordSpan">isClosed</span>())
		self._err = new Error(&#x22;Cursor is closed&#x22;);

	if (self._err) {
		if (cb) process.nextTick(function () {cb(self._err)})
		return;
	}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype.limit" id="apidoc.element.tingodb.tcursor.prototype.limit">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>limit
        <span class="apidocSignatureSpan">(v, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">limit = function (v, cb) {
	var self = this;
	if (!_.isFinite(v)) {
		self._err = new Error(&#x22;limit requires an integer&#x22;);
		if (!cb) throw self._err;
	}
	if (self._i!=0) {
		self._err = new Error(&#x27;Cursor is closed&#x27;);
		if (!cb) throw self._err;
	}
	if (!self._err) {
		this._limit = v==0?null:Math.abs(v);
	}
	if (cb)
		process.nextTick(function () {cb(self._err,self)})
	return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}


var findOpts = [&#x27;limit&#x27;,&#x27;sort&#x27;,&#x27;fields&#x27;,&#x27;skip&#x27;,&#x27;hint&#x27;,&#x27;timeout&#x27;,&#x27
;batchSize&#x27;,&#x27;safe&#x27;,&#x27;w&#x27;];

tcoll.prototype.findOne = _.rest(function (args) {
	var cb = args.pop();
	this.find.apply(this,args).<span class="apidocCodeKeywordSpan">limit</span>(1).nextObject(cb);
});

tcoll.prototype.find = function () {
	var cb = null, query = {}, opts = {}, fields = null, skip = null, limit = null, sort = null;
	var argc = arguments.length;
	if (argc&#x3e;0) {
		// guess callback, it is always latest
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype.nextObject" id="apidoc.element.tingodb.tcursor.prototype.nextObject">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>nextObject
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">nextObject = function (cb) {
	var self = this;
	if (self._err) {
		if (cb) process.nextTick(function () {cb(self._err)})
		return;
	}
	self._ensure(safe.sure(cb, function () {
		if (self._i&#x3e;=self._items.length)
			return cb(null, null);
		self._get(self._items[self._i], cb)
		self._i++;
	}))
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
}


var findOpts = [&#x27;limit&#x27;,&#x27;sort&#x27;,&#x27;fields&#x27;,&#x27;skip&#x27;,&#x27;hint&#x27;,&#x27;timeout&#x27;,&#x27
;batchSize&#x27;,&#x27;safe&#x27;,&#x27;w&#x27;];

tcoll.prototype.findOne = _.rest(function (args) {
	var cb = args.pop();
	this.find.apply(this,args).limit(1).<span class="apidocCodeKeywordSpan">nextObject</span>(cb);
});

tcoll.prototype.find = function () {
	var cb = null, query = {}, opts = {}, fields = null, skip = null, limit = null, sort = null;
	var argc = arguments.length;
	if (argc&#x3e;0) {
		// guess callback, it is always latest
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype.rewind" id="apidoc.element.tingodb.tcursor.prototype.rewind">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>rewind
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">rewind = function () {
	this._i=0;
	return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype.setReadPreference" id="apidoc.element.tingodb.tcursor.prototype.setReadPreference">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>setReadPreference
        <span class="apidocSignatureSpan">(the, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">setReadPreference = function (the, cb) {
	var self = this;
	if (self._err) {
		if (cb) process.nextTick(function () {cb(self._err)})
		return;
	}
	return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype.skip" id="apidoc.element.tingodb.tcursor.prototype.skip">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>skip
        <span class="apidocSignatureSpan">(v, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">skip = function (v, cb) {
	var self = this;
	if (!_.isFinite(v)) {
		self._err = new Error(&#x22;skip requires an integer&#x22;);
		if (!cb) throw self._err;
	}
	if (self._i!=0) {
		self._err = new Error(&#x27;Cursor is closed&#x27;);
		if (!cb) throw self._err;
	}
	if (!self._err)
		this._skip = v;
	if (cb)
		process.nextTick(function () {cb(self._err,self)})
	return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	limit = limit || opts.limit || null;
	fields = fields || opts.fields || null;
	sort = sort || opts.sort || null;


	var c = new tcursor(this,query, fields, opts);

	if (skip) c.<span class="apidocCodeKeywordSpan">skip</span>(skip);
	if (limit) c.limit(limit);
	if (sort) c.sort(sort);
	if (cb)
		cb(null, c)
	else
		return c;
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype.sort" id="apidoc.element.tingodb.tcursor.prototype.sort">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>sort
        <span class="apidocSignatureSpan">(v, d, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">sort = function (v, d, cb) {
	var self = this;
	if (_.isFunction(d)) {
		cb = d;
		d = null;
	}
	if (self._i!=0)
		this._err = new Error(&#x27;Cursor is closed&#x27;);
	if (!this._err) {
		this._err = _.attempt(function () {
			self.sortValue = v; // just to pass contrib test
			self._sort = parseSortList(v, d);
		});
	}
	if (cb)
		process.nextTick(function () {cb(self._err, self)})
	return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		cb = options;
		options = {};
	}
	cb = cb || function () {};
	options = options || {};

	var c = new tcursor(this,{},{},{});
	c.<span class="apidocCodeKeywordSpan">sort</span>(obj);
	if (c._err)
		return safe.back(cb,c._err);
	var key = c._sort;

	if (key===null)
		return safe.back(cb,new Error(&#x22;No fields are specified&#x22;));
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype.stream" id="apidoc.element.tingodb.tcursor.prototype.stream">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>stream
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">stream = function (options) {
	return new CursorStream(this, options);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tcursor.prototype.toArray" id="apidoc.element.tingodb.tcursor.prototype.toArray">
        function <span class="apidocSignatureSpan">tingodb.tcursor.prototype.</span>toArray
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toArray = function (cb) {
	if (!_.isFunction(cb))
		throw new Error(&#x27;Callback is required&#x27;);
	var self = this;

	if (self.isClosed())
		self._err = new Error(&#x22;Cursor is closed&#x22;);

	if (self._err) {
		if (cb) process.nextTick(function () {cb(self._err)})
		return;
	}

	self._ensure(safe.sure(cb, function () {
		safe.mapSeries(self._i!=0?self._items.slice(self._i,self._items.length):self._items, function (pos,cb) {
			self._get(pos, safe.sure(cb, function (obj) {
				cb(null, obj);
			}));
		}, safe.sure(cb, function (res) {
			self._i=self._items.length;
			cb(null, res);
		}))
	}))
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.tdb" id="apidoc.module.tingodb.tdb">module tingodb.tdb</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tdb.tdb" id="apidoc.element.tingodb.tdb.tdb">
        function <span class="apidocSignatureSpan">tingodb.</span>tdb
        <span class="apidocSignatureSpan">(path_, opts, gopts)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function tdb(path_, opts, gopts) {
	this._gopts = gopts;
	this._path = path.resolve(path_);
	this._cols = Object.create ? Object.create(null) : {};
	this._name = opts.name || path.basename(path_);
	this._stype = gopts.memStore?&#x22;mem&#x22;:&#x22;fs&#x22;;
	if (this._stype==&#x22;mem&#x22;)
		mstore[path_] = this._mstore = mstore[path_] || Object.create ? Object.create(null) : {};
	// mongodb compat variables
	this.openCalled = false;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.tdb.prototype" id="apidoc.module.tingodb.tdb.prototype">module tingodb.tdb.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tdb.prototype._cloneDeep" id="apidoc.element.tingodb.tdb.prototype._cloneDeep">
        function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>_cloneDeep
        <span class="apidocSignatureSpan">(obj)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_cloneDeep = function (obj) {
	var self = this;
	return _.cloneDeepWith(obj, function (c) {
		if (c instanceof self.ObjectID)
			return new c.constructor(c.toString());
		if (c instanceof self.Binary)
			return new c.constructor(new Buffer(c.value(true)));
	});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
tcache.prototype.clear = function () {
	for (var i=0; i&#x3c;this._cache.length; i++) {
		this._cache[i]={k:null};
	}
};

tcache.prototype.set = function (k,v) {
	this._cache[k%this.size] = {k:k,v:this._tdb.<span class="apidocCodeKeywordSpan">_cloneDeep</span>(v)};
};

tcache.prototype.unset = function (k) {
	var c = this._cache[k%this.size];
	if (c.k==k)
		this._cache[k%this.size]={k:null};
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tdb.prototype._collection" id="apidoc.element.tingodb.tdb.prototype._collection">
        function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>_collection
        <span class="apidocSignatureSpan">(cname, opts, create, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_collection = function (cname, opts, create, cb) {
	var err = this._nameCheck(cname);

	if (!cb) {
		cb = opts;
		opts = {};
	}
	cb = cb || function () {};
	if (err)
		return safe.back(cb, err);
	var self = this;
	var c = self._cols[cname];
	if (c) {
		if (opts.strict &#x26;&#x26; create) safe.back(cb, new Error(&#x22;Collection &#x22; + cname + &#x22; already exists. Currently in safe mode.&#x22;));
		else safe.back(cb, null, c);
		return c;
	}
	c = new tcoll(this);
	self._cols[cname] = c;
	c.init(this, cname, opts, create, function (err) {
		if (err) {
			delete self._cols[cname];
			cb(err);
		} else
			cb(null, c);
	});
	return c;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	if (!c)
		return safe.back(args[args.length - 1], new Error(&#x22;Collection doesn&#x27;t exists&#x22;));

	c.createIndex.apply(c, args);
});

tdb.prototype.collection = function (cname, opts, cb) {
	return this.<span class="apidocCodeKeywordSpan">_collection</span>(cname, opts,false, cb)
}

tdb.prototype.createCollection = function (cname, opts, cb) {
	return this._collection(cname, opts,true, cb)
}

tdb.prototype._nameCheck = function (cname) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tdb.prototype._nameCheck" id="apidoc.element.tingodb.tdb.prototype._nameCheck">
        function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>_nameCheck
        <span class="apidocSignatureSpan">(cname)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_nameCheck = function (cname) {
	var err = null;
	if (!_.isString(cname))
		err = new Error(&#x22;collection name must be a String&#x22;);
	if (!err &#x26;&#x26; cname.length==0)
		err = new Error(&#x22;collection names cannot be empty&#x22;);
	if (!err &#x26;&#x26; cname.indexOf(&#x22;$&#x22;)!=-1)
		err = new Error(&#x22;collection names must not contain &#x27;$&#x27;&#x22;);
	if (!err) {
		var di = cname.indexOf(&#x22;.&#x22;);
		if (di==0 || di==cname.length-1)
			err = new Error(&#x22;collection names must not start or end with &#x27;.&#x27;&#x22;);
	}
	if (!err &#x26;&#x26; cname.indexOf(&#x22;..&#x22;)!=-1)
		err = new Error(&#x22;collection names cannot be empty&#x22;);
	return err;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

tcoll.prototype.rename = function (nname, opts, cb) {
	var self = this;
	if (_.isFunction(opts)) {
		cb = opts;
		opts = {};
	}
	var err = self._tdb.<span class="apidocCodeKeywordSpan">_nameCheck</span>(nname);
	if (err)
		return safe.back(cb,err);
	if (self._tdb._stype==&#x22;mem&#x22;) {
		delete self._tdb._cols[self._name];
		self._tdb._cols[nname] = self;
		delete self._tdb._mstore[self._name];
		self._tdb._mstore[nname] = self._mstore;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tdb.prototype.close" id="apidoc.element.tingodb.tdb.prototype.close">
        function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>close
        <span class="apidocSignatureSpan">(forceClose, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">close = function (forceClose, cb) {
	var self = this;
	if (cb==null) cb = forceClose;
	cb = cb || function () {};
	// stop any further operations on current collections
	safe.eachOf(self._cols, function (c, k, cb) {
		c._stop(cb)
	}, safe.sure(cb, function () {
		// and clean list
		self._cols = Object.create ? Object.create(null) : {};
		this.openCalled = false;
		safe.back(cb,null,this);
	}))
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
					store[k] = { pos: wpos, sum: rec.sum };
					wpos += data.length;
					cb();
				}));
			}));
		}, function (err) {
			if (err) {
				fs.<span class="apidocCodeKeywordSpan">close</span>(fd, function () {
					fs.unlink(filename, function () {
						cb(err);
					});
				});
				return;
			}
			if (!!process.platform.match(/^win/)) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tdb.prototype.collection" id="apidoc.element.tingodb.tdb.prototype.collection">
        function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>collection
        <span class="apidocSignatureSpan">(cname, opts, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">collection = function (cname, opts, cb) {
	return this._collection(cname, opts,false, cb)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

```javascript
var Db = require(&#x27;mongodb&#x27;).Db,
	Server = require(&#x27;mongodb&#x27;).Server,
	assert = require(&#x27;assert&#x27;);

var db = new Db(&#x27;test&#x27;, new Server(&#x27;localhost&#x27;, 27017));
var collection = db.<span class="apidocCodeKeywordSpan">collection</span>(&#x22;batch_document_insert_collection_safe&#x22;);
collection.insert([{hello:&#x27;world_safe1&#x27;}
  , {hello:&#x27;world_safe2&#x27;}], {w:1}, function(err, result) {
  assert.equal(null, err);

  collection.findOne({hello:&#x27;world_safe2&#x27;}, function(err, item) {
	assert.equal(null, err);
	assert.equal(&#x27;world_safe2&#x27;, item.hello);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tdb.prototype.collectionNames" id="apidoc.element.tingodb.tdb.prototype.collectionNames">
        function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>collectionNames
        <span class="apidocSignatureSpan">(opts, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">collectionNames = function (opts, cb) {
	var self = this;
	if (_.isUndefined(cb)) {
		cb = opts;
		opts = {};
	}
	if (this._stype==&#x22;mem&#x22;) {
		cb(null,_(self._mstore).keys().map(function (e) { return opts.namesOnly?e:{name:self._name+&#x22;.&#x22;+e};}).value());
	} else {
		fs.readdir(self._path, safe.sure(cb,function(files) {
			// some collections ca be on disk and some only in memory, we need both
			files = _.union(files,_.keys(self._cols));
			cb(null,_(files)
				.reject(function (e) {return /^\./.test(e);}) // ignore hidden linux alike files
				.map(function (e) { return opts.namesOnly?e:{name:self._name+&#x22;.&#x22;+e};})
				.value());
		}));
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
				.value());
		}));
	}
};

tdb.prototype.collections = function (cb) {
	var self = this;
	self.<span class="apidocCodeKeywordSpan">collectionNames</span>({namesOnly:1},safe.sure(cb, function (names) {
		safe.forEach(names, function (cname, cb) {
			self.collection(cname, cb);
		},safe.sure(cb, function () {
			cb(null, _.values(self._cols));
		}));
	}));
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tdb.prototype.collections" id="apidoc.element.tingodb.tdb.prototype.collections">
        function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>collections
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">collections = function (cb) {
	var self = this;
	self.collectionNames({namesOnly:1},safe.sure(cb, function (names) {
		safe.forEach(names, function (cname, cb) {
			self.collection(cname, cb);
		},safe.sure(cb, function () {
			cb(null, _.values(self._cols));
		}));
	}));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
			cb(null,true);
		}
	}))
}

tdb.prototype.dropDatabase = function (cb) {
	var self = this;
	self.<span class="apidocCodeKeywordSpan">collections</span>(safe.sure(cb, function(collections) {
		safe.forEach(collections, function (c, cb) {
			self.dropCollection(c.collectionName,cb);
		},cb);
	}));
};

tdb.prototype.compactDatabase = function (cb) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tdb.prototype.compactDatabase" id="apidoc.element.tingodb.tdb.prototype.compactDatabase">
        function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>compactDatabase
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">compactDatabase = function (cb) {
	var self = this;
	self.collections(safe.sure(cb, function(collections) {
		safe.forEach(collections, function (c, cb) {
			c.compactCollection(cb);
		},cb);
	}));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tdb.prototype.createCollection" id="apidoc.element.tingodb.tdb.prototype.createCollection">
        function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>createCollection
        <span class="apidocSignatureSpan">(cname, opts, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">createCollection = function (cname, opts, cb) {
	return this._collection(cname, opts,true, cb)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tdb.prototype.createIndex" id="apidoc.element.tingodb.tdb.prototype.createIndex">
        function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>createIndex
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">createIndex = function () {
  var args = arguments,
      index = -1,
      length = nativeMax(args.length - start, 0),
      array = Array(length);

  while (++index &#x3c; length) {
    array[index] = args[start + index];
  }
  switch (start) {
    case 0: return func.call(this, array);
    case 1: return func.call(this, args[0], array);
    case 2: return func.call(this, args[0], args[1], array);
  }
  var otherArgs = Array(start + 1);
  index = -1;
  while (++index &#x3c; start) {
    otherArgs[index] = args[index];
  }
  otherArgs[start] = array;
  return apply(func, this, otherArgs);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tdb.prototype.dropCollection" id="apidoc.element.tingodb.tdb.prototype.dropCollection">
        function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>dropCollection
        <span class="apidocSignatureSpan">(cname, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">dropCollection = function (cname, cb) {
	var self = this;
	var c = this._cols[cname];
	if (!c) {
		var err = new Error(&#x22;ns not found&#x22;);
		if (cb) return safe.back(cb, err)
			else throw new err;
	}
	c._stop(safe.sure(cb, function (ondisk) {
		delete self._cols[cname];
		if (ondisk)
			fs.unlink(path.join(self._path,cname),safe.sure(cb, function () {
				cb(null, true)
			}))
		else {
			if (self._stype==&#x22;mem&#x22;)
				delete self._mstore[cname];
			cb(null,true);
		}
	}))
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
				}));
			}
		});
	}));
};

tcoll.prototype.drop = function (cb) {
	this._tdb.<span class="apidocCodeKeywordSpan">dropCollection</span>(this._name,cb);
};

tcoll.prototype.rename = function (nname, opts, cb) {
	var self = this;
	if (_.isFunction(opts)) {
		cb = opts;
		opts = {};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tdb.prototype.dropDatabase" id="apidoc.element.tingodb.tdb.prototype.dropDatabase">
        function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>dropDatabase
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">dropDatabase = function (cb) {
	var self = this;
	self.collections(safe.sure(cb, function(collections) {
		safe.forEach(collections, function (c, cb) {
			self.dropCollection(c.collectionName,cb);
		},cb);
	}));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tdb.prototype.open" id="apidoc.element.tingodb.tdb.prototype.open">
        function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>open
        <span class="apidocSignatureSpan">(options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">open = function (options, cb) {
	// actually do nothing for now, we are inproc
	// so nothing to open/close... collection will keep going on their own
	if (cb==null) cb = options;
	cb = cb || function () {};
	this.openCalled = true;
	safe.back(cb,null,this)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...


```javascript
var engine = require(&#x27;./engine&#x27;);
var db = engine.getDB();

console.time(&#x22;sample&#x22;)
db.<span class="apidocCodeKeywordSpan">open</span>(function(err,db) {
	db.collection(&#x22;homes&#x22;, function (err, homes) {
		// it&#x27;s fine to create ObjectID in advance
		// NOTE!!! we get class through engine because its type
		// can depends on database type
		var homeId = new engine.ObjectID();
		// but with TingoDB.ObjectID righ here it will be negative
		// which means temporary. However it&#x27;s unique and can be used for
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tdb.prototype.renameCollection" id="apidoc.element.tingodb.tdb.prototype.renameCollection">
        function <span class="apidocSignatureSpan">tingodb.tdb.prototype.</span>renameCollection
        <span class="apidocSignatureSpan">(on, nn, opts, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">renameCollection = function (on, nn, opts, cb) {
	if (cb==null) {
		cb = opts;
		opts = {};
	}
	cb = cb || safe.noop;
	var old = this._cols[on];
	if (old)
		old.rename(nn, {}, cb)
	else
		safe.back(cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.tindex" id="apidoc.module.tingodb.tindex">module tingodb.tindex</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tindex.tindex" id="apidoc.element.tingodb.tindex.tindex">
        function <span class="apidocSignatureSpan">tingodb.</span>tindex
        <span class="apidocSignatureSpan">(key, tcoll, options, name)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function tindex(key, tcoll, options, name) {
	this.options = options || {};
	this.name = name || key+&#x27;_&#x27;;
	this._unique = this.options.unique || false;
	this._c = tcoll;
	this._nuls = Object.create ? Object.create(null) : {};
	this._array = this.options._tiarr || false;
	this.key = key[0][0];
	this.order = key[0][1];
	if (key.length &#x3e; 1) this._sub = key.slice(1);
	this._bp = BPlusTree.create({ sort: this.order, order: 100 });
	var getter = new tcoll._tdb.Finder.field(this.key);
	this._get = new Function(&#x22;obj&#x22;, &#x22;return &#x22; + (this._array ? getter.native3() : getter.native()));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.tindex.prototype" id="apidoc.module.tingodb.tindex.prototype">module tingodb.tindex.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tindex.prototype._del" id="apidoc.element.tingodb.tindex.prototype._del">
        function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>_del
        <span class="apidocSignatureSpan">(k, v, o)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_del = function (k, v, o) {
	if (this._sub) {
		var s = (_.isNull(k) || _.isUndefined(k)) ? this._nuls[v] : this._bp.get(k);
		if (s) s.del(o, v);
		return;
	}
	delete this._nuls[v];
	if (this._unique) {
		this._bp.del(k);
	}
	else {
		var l = this._bp.get(k);
		if (l) {
			var i = l.indexOf(v);
			if (i != -1)
				l.splice(i, 1);
			if (l.length===0)
				this._bp.del(k);
		}
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};

tindex.prototype.del = function (k_,v) {
	var self = this;
	var k = this._get(k_);
	if (_.isArray(k)) {
		_.each(k, function (k1) {
			self.<span class="apidocCodeKeywordSpan">_del</span>(k1, v, k_);
		});
	}
	else
		return this._del(k, v, k_);
};

tindex.prototype._del = function (k, v, o) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tindex.prototype._set" id="apidoc.element.tingodb.tindex.prototype._set">
        function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>_set
        <span class="apidocSignatureSpan">(k, v, o)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_set = function (k, v, o) {
	if (this._sub) {
		var s = (_.isNull(k) || _.isUndefined(k)) ? this._nuls[v] : this._bp.get(k);
		if (!s) {
			s = new tindex(this._sub, this._c, this.options, this.name + &#x27;_&#x27; + k);
			if (_.isNull(k) || _.isUndefined(k)) this._nuls[v] = s;
				else this._bp.set(k, s);
		}
		s.set(o, v);
		return;
	}
	if (_.isNull(k) || _.isUndefined(k)) {
		this._nuls[v]=v;
		return;
	}
	if (this._unique)
		return this._bp.set(k,v);
	else {
		var l = this._bp.get(k);
		var n = l || [];
		n.push(v);
		if (!l) this._bp.set(k,n);
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

	if (check) {
		if (!this._sub &#x26;&#x26; this._unique &#x26;&#x26; this._bp.get(k) !== null)
			throw new Error(&#x22;duplicate key error index&#x22;);
	} else {
		if (_.isArray(k)) {
			_.each(k, function (k1) {
				self.<span class="apidocCodeKeywordSpan">_set</span>(k1, v, k_);
			});
		}
		else
			return this._set(k, v, k_);
	}
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tindex.prototype.all" id="apidoc.element.tingodb.tindex.prototype.all">
        function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>all
        <span class="apidocSignatureSpan">(order, shallow)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">all = function (order, shallow) {
	var a = this._bp.all();
	var n = _.values(this._nuls);
	var r = this.order &#x3e; 0 ? _.union(n, a) : _.union(a, n);
	if (order &#x26;&#x26; order.length &#x3e; 0) {
		if (order[0] != this.order) r = r.reverse();
		order = order.slice(1);
	}
	if (this._sub) return shallow ? r : _(r).map(function (i) { return i.all(order); }).flattenDeep().value();
	return this._unique?r:_.flatten(r);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
			return s;
		}
	},
	$ne : function () {
		this.op = &#x22;$ne&#x22;;
		this._index = function (index) {
			var m = index.match(this._args[1]._get());
			var a = index.<span class="apidocCodeKeywordSpan">all</span>();
			return _.difference(a,m);
		},
		this._ex = function (f) {
			if (this.fields()[f]!=null)
				return 1;
			else
				return -1;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tindex.prototype.clear" id="apidoc.element.tingodb.tindex.prototype.clear">
        function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>clear
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">clear = function () {
	if (this.count())
		this._bp = BPlusTree.create({ sort: this.order, order: 100 });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
// var BPlusTree = require(&#x27;./bplustree&#x27;);

function tcache (tdb, size) {
	this._tdb = tdb;
	this.size = size || 1000;
	this._cache = [];
	this._cache.length = this.size;
	this.<span class="apidocCodeKeywordSpan">clear</span>();
}

tcache.prototype.clear = function () {
	for (var i=0; i&#x3c;this._cache.length; i++) {
		this._cache[i]={k:null};
	}
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tindex.prototype.count" id="apidoc.element.tingodb.tindex.prototype.count">
        function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>count
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">count = function () {
	var c = 0;
	this._bp.each(function (k,v) {
		c += this._sub ? v.count() : v.length;
	});
	return c;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
							var query = &#x22;/rooms?homeid=&#x22;+homeId.toString();
							// dirty code to get simulated GET variable
							var getId = query.match(&#x22;homeid=(.*)&#x22;)[1];
							console.log(query, getId)
							// typical code to get id from external world
							// and use it for queries
							rooms.find({_idHome:new engine.ObjectID(getId)})
								.<span class="apidocCodeKeywordSpan">count</span>(function (err, count) {
									console.log(count);
									console.timeEnd(&#x22;sample&#x22;);
							})
						}
					})
				}
			})
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tindex.prototype.del" id="apidoc.element.tingodb.tindex.prototype.del">
        function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>del
        <span class="apidocSignatureSpan">(k_, v)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">del = function (k_, v) {
	var self = this;
	var k = this._get(k_);
	if (_.isArray(k)) {
		_.each(k, function (k1) {
			self._del(k1, v, k_);
		});
	}
	else
		return this._del(k, v, k_);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		}

		// update index
		_.each(self._idx,function(v,k) {
			if (!remove)
				v.set(item,key._id);
			else
				v.<span class="apidocCodeKeywordSpan">del</span>(item,key._id);
		})
		cb(null);
	}, true, cb);
}


tcoll.prototype._putFS = function (item, remove, cb) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tindex.prototype.depth" id="apidoc.element.tingodb.tindex.prototype.depth">
        function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>depth
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">depth = function () {
	return this._sub ? this._sub.length + 1 : 1;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		// compare each potential index with each other
		_.each(pi,function (v1, i1) {
			_.each(pi,function (v2, i2) {
				if (i1 == i2) return;
				// compare the set of possible keys for both indexes
				if (_.union(v1.k, v2.k).length == v1.k.length) {
					// key for v2 is a subset of key for v1, check equality
					if (v1.k.length == v2.k.length &#x26;&#x26; v1.i.<span class="apidocCodeKeywordSpan">depth</span>() &#x3e; v2.i.depth()) {
						// keys are equal, but the depth of v2 is lower;
						// v2 is preferable, strike out v1
						pi.splice(i1, 1);
					} else {
						// in other two cases v1 is preferable, strike out v2
						pi.splice(i2, 1);
					}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tindex.prototype.fields" id="apidoc.element.tingodb.tindex.prototype.fields">
        function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>fields
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">fields = function () {
	var result = [ [ this.key, this.order ] ];
	if (this._sub) result = result.concat(this._sub);
	return result;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	$lt : function () {
		this.op = &#x22;$lt&#x22;;
		this._index = function (index) {
			if (index.order &#x3e; 0) return index.range(null, this._args[1]._get(), false, true);
			else return index.range(this._args[1]._get(), null, true, false);
		};
		this._ex = function (f) {
			if (this.<span class="apidocCodeKeywordSpan">fields</span>()[f]!=null)
				return 1;
			else
				return -1;
		}
		this.dump = function () {
			return this._args[0].dump() +&#x22; &#x3c; &#x22; +this._args[1].dump()
		}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tindex.prototype.inspect" id="apidoc.element.tingodb.tindex.prototype.inspect">
        function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>inspect
        <span class="apidocSignatureSpan">(depth)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">inspect = function (depth) {
	return &#x27;[Index &#x27; + this.name + &#x27;]&#x27;;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tindex.prototype.match" id="apidoc.element.tingodb.tindex.prototype.match">
        function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>match
        <span class="apidocSignatureSpan">(k)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">match = function (k) {
	var m = this._bp.get(k);
	if (!m) return [];
	return this._unique || this._sub ? [ m ] : m;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
						console.log(room[0]);
						i--;
						if (i==0) {
							// now lets assume we serving request like
							// /rooms?homeid=_some_string_
							var query = &#x22;/rooms?homeid=&#x22;+homeId.toString();
							// dirty code to get simulated GET variable
							var getId = query.<span class="apidocCodeKeywordSpan">match</span>(&#x22;homeid=(.*)&#x22;)[1];
							console.log(query, getId)
							// typical code to get id from external world
							// and use it for queries
							rooms.find({_idHome:new engine.ObjectID(getId)})
								.count(function (err, count) {
									console.log(count);
									console.timeEnd(&#x22;sample&#x22;);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tindex.prototype.nuls" id="apidoc.element.tingodb.tindex.prototype.nuls">
        function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>nuls
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">nuls = function () {
	return _.values(this._nuls);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	},
	$exists : function () {
		this.op = &#x22;$exists&#x22;;
		this._index = function (index) {
			if (this._args[1]._get())
				return index.values();
			else
				return index.<span class="apidocCodeKeywordSpan">nuls</span>();
		},
		this._ex = function (f) {
			if (this.fields()[f]!=null)
				return 1;
			else
				return -1;
		}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tindex.prototype.range" id="apidoc.element.tingodb.tindex.prototype.range">
        function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>range
        <span class="apidocSignatureSpan">(s, e, si, ei)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">range = function (s, e, si, ei) {
	var r = this._bp.rangeSync(s,e,si,ei);
	return this._unique || this._sub ? r : _.flatten(r);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var ops = {
	$range : function () {
		this.op = &#x22;$range&#x22;;
		this.dump = function () {
			return this._args[0].dump() +&#x22; in range (&#x22; +this._args[1].dump()+&#x22;,&#x22;+this._args[2].dump()+&#x22;,&#x22;+this
._args[3].dump()+&#x22;,&#x22;+this._args[4].dump()+&#x22;)&#x22;;
		},
		this._index = function (index) {
			if (index.order &#x3e; 0) return index.<span class="apidocCodeKeywordSpan">range</span>(this._args[1]._get(), this._args[2]._get
(), this._args[3]._get(), this._args[4]._get());
			else return index.range(this._args[2]._get(), this._args[1]._get(), this._args[4]._get(), this._args[3]._get());
		}
	},

	$lt : function () {
		this.op = &#x22;$lt&#x22;;
		this._index = function (index) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tindex.prototype.set" id="apidoc.element.tingodb.tindex.prototype.set">
        function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>set
        <span class="apidocSignatureSpan">(k_, v, check)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">set = function (k_, v, check) {
	var self = this;
	var k = this._get(k_);

	if (check) {
		if (!this._sub &#x26;&#x26; this._unique &#x26;&#x26; this._bp.get(k) !== null)
			throw new Error(&#x22;duplicate key error index&#x22;);
	} else {
		if (_.isArray(k)) {
			_.each(k, function (k1) {
				self._set(k1, v, k_);
			});
		}
		else
			return this._set(k, v, k_);
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	}
	this._tq = new wqueue(100, function (cb) {
		// update indexes
		safe.eachOfSeries(self._store, function (rec, k, cb) {
			self._get(rec.pos, false, safe.sure(cb, function (obj) {
				var id = simplifyKey(obj._id);
				_.each(self._idx,function(v, k) {
					v.<span class="apidocCodeKeywordSpan">set</span>(obj, id);
				});
				cb();
			}));
		}, cb);
	});
	self.ensureIndex({_id: 1}, {name: &#x27;_id_&#x27;, unique: true}, cb);
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tindex.prototype.values" id="apidoc.element.tingodb.tindex.prototype.values">
        function <span class="apidocSignatureSpan">tingodb.tindex.prototype.</span>values
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">values = function () {
	var r = this._bp.all();
	return this._unique || this._sub ? r : _.flatten(r);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
			return s;
		}
	},
	$exists : function () {
		this.op = &#x22;$exists&#x22;;
		this._index = function (index) {
			if (this._args[1]._get())
				return index.<span class="apidocCodeKeywordSpan">values</span>();
			else
				return index.nuls();
		},
		this._ex = function (f) {
			if (this.fields()[f]!=null)
				return 1;
			else
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.tstream" id="apidoc.module.tingodb.tstream">module tingodb.tstream</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tstream.tstream" id="apidoc.element.tingodb.tstream.tstream">
        function <span class="apidocSignatureSpan">tingodb.</span>tstream
        <span class="apidocSignatureSpan">(cursor, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function CursorStream(cursor, options) {
  if(!(this instanceof CursorStream)) return new CursorStream(cursor);
  options = options ? options : {};

  Stream.call(this);

  this.readable = true;
  this.paused = false;
  this._cursor = cursor;
  this._destroyed = null;
  this.options = options;

  // give time to hook up events
  var self = this;
  process.nextTick(function() {
    self._init();
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.tstream.prototype" id="apidoc.module.tingodb.tstream.prototype">module tingodb.tstream.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.tstream.prototype._init" id="apidoc.element.tingodb.tstream.prototype._init">
        function <span class="apidocSignatureSpan">tingodb.tstream.prototype.</span>_init
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_init = function () {
  if (this._destroyed) return;
  this._next();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var inproc_id = -1;
var tempset = {};
function ObjectID(val) {
	// every new instance will have temporary inproc unique value
	// minus sign will let know to db layer that value is temporary
	// and need to be replaced
	this.id = --inproc_id;
	this.<span class="apidocCodeKeywordSpan">_init</span>(val);
	// we need to keep track all temporary instances with goal
	// to update them at later tima
	if (this.id&#x3c;0) {
		if (!tempset[this.id])
			tempset[this.id]=[this];
		else
			tempset[this.id].push(this);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tstream.prototype._next" id="apidoc.element.tingodb.tstream.prototype._next">
        function <span class="apidocSignatureSpan">tingodb.tstream.prototype.</span>_next
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_next = function () {
  if(this.paused || this._destroyed) return;

  var self = this;
  // Get the next object
  processor(function() {
    if(self.paused || self._destroyed) return;

    self._cursor.nextObject(function (err, doc) {
      self._onNextObject(err, doc);
    });
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
/**
* Initialize the cursor.
* @ignore
* @api private
*/
CursorStream.prototype._init = function () {
 if (this._destroyed) return;
 this.<span class="apidocCodeKeywordSpan">_next</span>();
}

/**
* Pull the next document from the cursor.
* @ignore
* @api private
*/
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tstream.prototype._onNextObject" id="apidoc.element.tingodb.tstream.prototype._onNextObject">
        function <span class="apidocSignatureSpan">tingodb.tstream.prototype.</span>_onNextObject
        <span class="apidocSignatureSpan">(err, doc)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_onNextObject = function (err, doc) {
  if(err) return this.destroy(err);

  // when doc is null we hit the end of the cursor
  //if(!doc &#x26;&#x26; (this._cursor.state == 1 || this._cursor.state == 2)) {
  if(!doc) {
    this.emit(&#x27;end&#x27;)
    return this.destroy();
  } else if(doc) {
    var data = _.isFunction(this.options.transform) ? this.options.transform(doc) : doc;
    this.emit(&#x27;data&#x27;, data);
    this._next();
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

 var self = this;
 // Get the next object
 processor(function() {
   if(self.paused || self._destroyed) return;

   self._cursor.nextObject(function (err, doc) {
     self.<span class="apidocCodeKeywordSpan">_onNextObject</span>(err, doc);
   });
 });
}

/**
* Handle each document as its returned from the cursor.
* @ignore
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tstream.prototype.destroy" id="apidoc.element.tingodb.tstream.prototype.destroy">
        function <span class="apidocSignatureSpan">tingodb.tstream.prototype.</span>destroy
        <span class="apidocSignatureSpan">(err)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">destroy = function (err) {
  if (this._destroyed) return;
  this._destroyed = true;
  this.readable = false;

  this._cursor.close();

  if(err) {
    this.emit(&#x27;error&#x27;, err);
  }

  this.emit(&#x27;close&#x27;);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

/**
 * Handle each document as its returned from the cursor.
 * @ignore
 * @api private
 */
CursorStream.prototype._onNextObject = function (err, doc) {
if(err) return this.<span class="apidocCodeKeywordSpan">destroy</span>(err);

// when doc is null we hit the end of the cursor
//if(!doc &#x26;&#x26; (this._cursor.state == 1 || this._cursor.state == 2)) {
if(!doc) {
  this.emit(&#x27;end&#x27;)
  return this.destroy();
} else if(doc) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tstream.prototype.pause" id="apidoc.element.tingodb.tstream.prototype.pause">
        function <span class="apidocSignatureSpan">tingodb.tstream.prototype.</span>pause
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">pause = function () {
  this.paused = true;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.tstream.prototype.resume" id="apidoc.element.tingodb.tstream.prototype.resume">
        function <span class="apidocSignatureSpan">tingodb.tstream.prototype.</span>resume
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">resume = function () {
  var self = this;

  // Don&#x27;t do anything if we are not paused
  if(!this.paused) return;
  //if(!this._cursor.state == 3) return;

  process.nextTick(function() {
    self.paused = false;
    // Only trigger more fetching if the cursor is open
    self._next();
  })
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.utils" id="apidoc.module.tingodb.utils">module tingodb.utils</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.utils.intersectIndexes" id="apidoc.element.tingodb.utils.intersectIndexes">
        function <span class="apidocSignatureSpan">tingodb.utils.</span>intersectIndexes
        <span class="apidocSignatureSpan">(indexes, base)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">intersectIndexes = function (indexes, base) {
	// do intersection of indexes using hashes
	var ops = [], i = 0;
	// convert to hashes
	for (i=0; i&#x3c;indexes.length; i++) {
		var ids = {};
		_.each(indexes[i], function (id) {
			ids[id]=id;
		})
		ops.push(ids);
	}
	// find minimal one
	if (_.isUndefined(base)) {
		base = 0;
		for (i=0; i&#x3c;ops.length; i++) {
			if (ops[i].length&#x3c;ops[base].length)
				base = i;
		}
	}
	// iterate over it
	var m = [];
	_.each(indexes[base], function (id) {
		var match = true;
		for (var i=0; i&#x3c;ops.length; i++) {
			if (i==base) continue;
			if (!ops[i][id]) {
				match = false;
				break;
			}
		}
		if (match)
			m.push(id);
	})
	return m;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
					// so the result is sorted, but in reverse direction
					p.reverse();
					sort = null;
				}
			}
		} else {
			// TODO: use sort index as intersect base to speedup sorting
			p = tutils.<span class="apidocCodeKeywordSpan">intersectIndexes</span>(p);
		}
		// nowe we have ids, need to convert them to positions
		range = _.map(p,function (_id) {
			return self._store[_id].pos;
		})
	} else {
		if (si) {
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.wqueue" id="apidoc.module.tingodb.wqueue">module tingodb.wqueue</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.wqueue.wqueue" id="apidoc.element.tingodb.wqueue.wqueue">
        function <span class="apidocSignatureSpan">tingodb.</span>wqueue
        <span class="apidocSignatureSpan">(limit, first)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function wqueue(limit, first) {
	this.limit = limit || 100;
	this._rc = 0;
	this._q = [];
	this._blocked = false;
	this._stoped = false;
	this._tc = -1;
	this.first = first || function (cb) {cb()};
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.tingodb.wqueue.prototype" id="apidoc.module.tingodb.wqueue.prototype">module tingodb.wqueue.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.tingodb.wqueue.prototype._exec" id="apidoc.element.tingodb.wqueue.prototype._exec">
        function <span class="apidocSignatureSpan">tingodb.wqueue.prototype.</span>_exec
        <span class="apidocSignatureSpan">(task, block, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_exec = function (task, block, cb) {
	var self = this;
	self._blocked = block;
	self._tc++;
	if (self._tc==0) {
		self._blocked = true;
		self.first(function (err) {
			if (err) {
				// restore to initial state on error
				self._blocked = false;
				self._tc--;
				return cb(err);
			}
			self._exec(task,block,cb)
		})
	} else {
		self._rc++;
		task(function () {
			cb.apply(this,arguments)
			self._rc--;
			if (self._rc==0)
				self._blocked = false;
			self._ping();
		})
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		self.first(function (err) {
			if (err) {
				// restore to initial state on error
				self._blocked = false;
				self._tc--;
				return cb(err);
			}
			self.<span class="apidocCodeKeywordSpan">_exec</span>(task,block,cb)
		})
	} else {
		self._rc++;
		task(function () {
			cb.apply(this,arguments)
			self._rc--;
			if (self._rc==0)
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.wqueue.prototype._ping" id="apidoc.element.tingodb.wqueue.prototype._ping">
        function <span class="apidocSignatureSpan">tingodb.wqueue.prototype.</span>_ping
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_ping = function () {
	var self = this;
	process.nextTick(function () {
		while (self._q.length&#x3e;0 &#x26;&#x26; self._rc&#x3c;self.limit &#x26;&#x26; !self._blocked &#x26;&#x26; (!self._q[0].block || self._rc==0)  ) {
			var t = self._q.splice(0,1)[0];
			if (self._stoped)
				t.cb(new Error(&#x22;Database is closed&#x22;));
			else {
				self._exec(t.task, t.block, t.cb)
			}
		}
	})
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	this._stoped = false;
	this._tc = -1;
	this.first = first || function (cb) {cb()};
}

wqueue.prototype.add = function(task,block,cb) {
	this._q.push({task:task,block:block, cb:cb});
	this.<span class="apidocCodeKeywordSpan">_ping</span>();
}

wqueue.prototype._exec = function (task,block,cb) {
	var self = this;
	self._blocked = block;
	self._tc++;
	if (self._tc==0) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.tingodb.wqueue.prototype.add" id="apidoc.element.tingodb.wqueue.prototype.add">
        function <span class="apidocSignatureSpan">tingodb.wqueue.prototype.</span>add
        <span class="apidocSignatureSpan">(task, block, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">add = function (task, block, cb) {
	this._q.push({task:task,block:block, cb:cb});
	this._ping();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		});
	});
	self.ensureIndex({_id: 1}, {name: &#x27;_id_&#x27;, unique: true}, cb);
};

tcoll.prototype.compactCollection = function (cb) {
	var self = this;
	self._tq.<span class="apidocCodeKeywordSpan">add</span>(function (cb) {
		self._compact(safe.sure(cb, function () {
			self._cache.clear();
			self._refreshIndexes(cb);
		}));
	}, true, cb);
};
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
